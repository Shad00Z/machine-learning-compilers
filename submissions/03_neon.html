

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. Neon &mdash; Machine Learning Compilers  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Code Generation" href="04_code_gen.html" />
    <link rel="prev" title="2. Base" href="02_base.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Machine Learning Compilers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Project Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/01_project_information.html">Machine Learning Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/02_docu_setup.html">Documentation Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Submissions</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_assembly.html">1. Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_base.html">2. Base</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. Neon</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#execution-throughput-and-latency">3.1 Execution Throughput and Latency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#throughput">3.1.1 Throughput</a></li>
<li class="toctree-l3"><a class="reference internal" href="#latency">3.1.2 Latency</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#microkernel">3.2 Microkernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#neon-microkernel">3.2.1 Neon Microkernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-and-benchmarking">3.2.2 Testing and Benchmarking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#loops">3.3 Loops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.3.1 Testing and Benchmarking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#simd-lanes">3.4 SIMD Lanes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#matmul-14-6-64">3.4.1 Matmul_14_6_64</a></li>
<li class="toctree-l3"><a class="reference internal" href="#matmul-15-6-64">3.4.2 Matmul_15_6_64</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-approach">3.4.3 Generic Approach</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#accumulator-block-shapes">3.5 Accumulator Block Shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#batch-reduce-gemm">3.6 Batch-Reduce GEMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transposition">3.7 Transposition</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#transposition-implementation">3.7.1 Transposition Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-measuring">3.7.2 Performance Measuring</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="04_code_gen.html">4. Code Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_tensor_op.html">5. Tensor Operation Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_einsum.html">6. Einsum Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_individual_phase.html">7. Individual Phase</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit.html">mini_jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_benchmarks.html">mini_jit::benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_converters.html">mini_jit::converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_einsum.html">mini_jit::einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_instructions.html">mini_jit::instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_ir.html">mini_jit::ir</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_kernels.html">mini_jit::kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_registers.html">mini_jit::registers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Machine Learning Compilers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">3. Neon</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/submissions/03_neon.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="neon">
<h1>3. Neon<a class="headerlink" href="#neon" title="Link to this heading"></a></h1>
<section id="execution-throughput-and-latency">
<h2>3.1 Execution Throughput and Latency<a class="headerlink" href="#execution-throughput-and-latency" title="Link to this heading"></a></h2>
<p>For this task, we were benchmarking the execution throughput and latency for FP32 neon instructions.
Specifically, we were looking at:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://developer.arm.com/documentation/ddi0602/2025-03/SIMD-FP-Instructions/FMLA--vector---Floating-point-fused-multiply-add-to-accumulator--vector--">FMLA (vector)</a> instruction</p></li>
<li><p><a class="reference external" href="https://developer.arm.com/documentation/ddi0602/2025-03/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--?lang=en">FMADD (scalar)</a> instruction</p></li>
</ol>
<section id="throughput">
<h3>3.1.1 Throughput<a class="headerlink" href="#throughput" title="Link to this heading"></a></h3>
<p>As a first step we were comparing the throughput of:</p>
<ol class="arabic simple">
<li><p>FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code></p></li>
<li><p>FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></p></li>
<li><p>FMADD (scalar), single-precision variant</p></li>
</ol>
<p>To compare the throughput, we created three assembly programs, that were executing
several of these operations. To get proper results we were looking for any dependencies
regarding the source or destination registers of the operations.
The calculations that we were ending up with were:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code></span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="nl">loop:</span>
<span class="linenos">32</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span>
<span class="linenos">37</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.4s</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.4s</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.4s</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.4s</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.4s</span>
<span class="linenos">52</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.4s</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span>
<span class="linenos">58</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.4s</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.4s</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.4s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.4s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v28.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v29.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v30.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v31.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">71</span><span class="w">    </span><span class="na">.endr</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">31</span><span class="nl">loop:</span>
<span class="linenos">32</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v0.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.2s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v1.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.2s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.2s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.2s</span>
<span class="linenos">37</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.2s</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v5.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.2s</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.2s</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.2s</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.2s</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.2s</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v20.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.2s</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.2s</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.2s</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.2s</span>
<span class="linenos">52</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.2s</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.2s</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.2s</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.2s</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v28.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.2s</span>
<span class="linenos">58</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.2s</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v30.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.2s</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v31.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.2s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v0.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v8.2s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v25.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.2s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v26.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.2s</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.2s</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v28.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v29.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v5.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.2s</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v30.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.2s</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v31.2s</span><span class="p">,</span><span class="w">  </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.2s</span>
<span class="linenos">71</span><span class="w">    </span><span class="na">.endr</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">FMADD (scalar), single-precision variant</span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="nl">loop:</span>
<span class="linenos">40</span><span class="w">    </span><span class="na">.rept</span><span class="w"> </span><span class="mi">100</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span>
<span class="linenos">49</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span>
<span class="linenos">50</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w"> </span><span class="no">s0</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">fmadd</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s1</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w"> </span><span class="no">s2</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w"> </span><span class="no">s3</span>
<span class="linenos">55</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w"> </span><span class="no">s4</span>
<span class="linenos">56</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s5</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w"> </span><span class="no">s6</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w"> </span><span class="no">s7</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s16</span><span class="p">,</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w"> </span><span class="no">s8</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s17</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="no">s9</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s18</span><span class="p">,</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s19</span><span class="p">,</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span>
<span class="linenos">64</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s20</span><span class="p">,</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s21</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span>
<span class="linenos">67</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s22</span><span class="p">,</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span>
<span class="linenos">68</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s23</span><span class="p">,</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s24</span><span class="p">,</span><span class="w">  </span><span class="no">s0</span><span class="p">,</span><span class="w">  </span><span class="no">s8</span><span class="p">,</span><span class="w"> </span><span class="no">s16</span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w">  </span><span class="no">s1</span><span class="p">,</span><span class="w">  </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s17</span>
<span class="linenos">72</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s26</span><span class="p">,</span><span class="w">  </span><span class="no">s2</span><span class="p">,</span><span class="w"> </span><span class="no">s10</span><span class="p">,</span><span class="w"> </span><span class="no">s18</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s27</span><span class="p">,</span><span class="w">  </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s19</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s28</span><span class="p">,</span><span class="w">  </span><span class="no">s4</span><span class="p">,</span><span class="w"> </span><span class="no">s12</span><span class="p">,</span><span class="w"> </span><span class="no">s20</span>
<span class="linenos">75</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w">  </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s13</span><span class="p">,</span><span class="w"> </span><span class="no">s21</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s30</span><span class="p">,</span><span class="w">  </span><span class="no">s6</span><span class="p">,</span><span class="w"> </span><span class="no">s14</span><span class="p">,</span><span class="w"> </span><span class="no">s22</span>
<span class="linenos">78</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s31</span><span class="p">,</span><span class="w">  </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s15</span><span class="p">,</span><span class="w"> </span><span class="no">s23</span>
<span class="linenos">79</span><span class="w">    </span><span class="na">.endr</span>
<span class="linenos">80</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">subs</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">82</span><span class="w">    </span><span class="nf">b.gt</span><span class="w"> </span><span class="no">loop</span>
</pre></div>
</div>
</div>
<p>In order to measure the throughput of these instructions we developed a C++ microbenchmark.
For each instruction we firstly performed a warm up, measured the time, counted the operations and then calculated the GFLOPs.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Example benchmark for FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code></span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">61</span><span class="w">        </span><span class="c1">// Warmup</span>
<span class="linenos">62</span><span class="w">        </span><span class="n">fmla_4s_instr</span><span class="p">(</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">g_4s_registers</span><span class="w"> </span><span class="p">);</span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="linenos">65</span><span class="w">        </span><span class="n">fmla_4s_instr</span><span class="p">(</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">g_4s_registers</span><span class="w"> </span><span class="p">);</span>
<span class="linenos">66</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="linenos">67</span><span class="w">        </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span>
<span class="linenos">68</span>
<span class="linenos">69</span><span class="w">        </span><span class="c1">// per FMLA: 4 Muls, 4 Adds</span>
<span class="linenos">70</span><span class="w">        </span><span class="c1">// 32 fmla</span>
<span class="linenos">71</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">72</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">73</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">2S</span></code> and the FMADD (scalar) instructions, we simply adjusted the calculations for the operations slightly:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Calculations for FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">85</span><span class="w">        </span><span class="c1">// per FMLA: 2 Muls, 2 Adds</span>
<span class="linenos">86</span><span class="w">        </span><span class="c1">// 32 fmla</span>
<span class="linenos">87</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">88</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">89</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">Calculations for FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code></span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">101</span><span class="w">        </span><span class="c1">// per FMADD: 1 Mul, 1 Add</span>
<span class="linenos">102</span><span class="w">        </span><span class="c1">// 32 fmadd</span>
<span class="linenos">103</span><span class="w">        </span><span class="c1">// rept 100</span>
<span class="linenos">104</span><span class="w">        </span><span class="c1">// n: loop iterations</span>
<span class="linenos">105</span><span class="w">        </span><span class="n">totalOps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>For this benchmarking task we obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Throughput results for the three instructions</span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking FMLA 4s throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for FMLA_4sInstruction
<span class="linenos"> 4</span>Total time (s):   1.96706
<span class="linenos"> 5</span>Instructions per Second:   1.30144e+11
<span class="linenos"> 6</span>Estimated GOPS:   130.144 GFLOPs/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking FMLA 2s throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for FMLA_2sInstruction
<span class="linenos">12</span>Total time (s):   2.53647
<span class="linenos">13</span>Instructions per Second:   5.04638e+10
<span class="linenos">14</span>Estimated GOPS:   50.4638 GFLOPs/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking FMADD throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for FMADDInstruction
<span class="linenos">20</span>Total time (s):   3.52918
<span class="linenos">21</span>Instructions per Second:   1.81345e+10
<span class="linenos">22</span>Estimated GOPS:   18.1345 GFLOPs/sec
<span class="linenos">23</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>It can be seen that the FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code> instruction performs approximately
2.5 times as many floating point operations than the FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code> instruction.
Further the FMLA (vector) with arrangement specifier <code class="docutils literal notranslate"><span class="pre">2S</span></code> instructions performs at approximately 2.5 times more
floating point operations than the FMADD (scalar) instruction.</p>
<p>This shows that leveraging data-level parallelism (vector-based) can yield a much higher throughput, than using only scalar operations.</p>
</section>
<section id="latency">
<h3>3.1.2 Latency<a class="headerlink" href="#latency" title="Link to this heading"></a></h3>
<p>To measure the execution latency for FMLA (vector) instructions with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code>, we examined two scenarios:</p>
<ol class="arabic simple">
<li><p>Each instruction depends on the destination register and one of the source register of the previous instruction</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">fmla instructions with dependencies on the destination register and one of the source registers</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Each instruction depends only on the destination register of the previous instruction</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">fmla instructions with dependencies on the destination register</span><a class="headerlink" href="#id13" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v1.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v9.4s</span>
<span class="linenos">34</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span>
<span class="linenos">35</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span>
<span class="linenos">36</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w">  </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span>
</pre></div>
</div>
</div>
<p>Both files contain 32 fmla instructions each, which are executed 100 times. The results of our benchmark is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">Latency results for the two scenarios</span><a class="headerlink" href="#id14" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">25</span>Benchmarking FMLA 4s source register latency ...
<span class="linenos">26</span>-----------------------------------------------
<span class="linenos">27</span>Measuring latency for FMLA_SourceInstruction
<span class="linenos">28</span>Total time (s):   3.30277
<span class="linenos">29</span>Instructions per Second:   1.16266e+10
<span class="linenos">30</span>Estimated GOPS:   11.6266 GFLOPs/sec
<span class="linenos">31</span>-----------------------------------------------
<span class="linenos">32</span>
<span class="linenos">33</span>Benchmarking FMLA 4s destination register latency ...
<span class="linenos">34</span>-----------------------------------------------
<span class="linenos">35</span>Measuring latency for FMLA_DestinationInstruction
<span class="linenos">36</span>Total time (s):   3.30207
<span class="linenos">37</span>Instructions per Second:   1.16291e+10
<span class="linenos">38</span>Estimated GOPS:   11.6291 GFLOPs/sec
<span class="linenos">39</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>We can see that both scenarios have similar results, which is why we computed the latency only for the first scenario.</p>
<p>We measured <span class="math notranslate nohighlight">\(1.16266 \times 10^{10}\)</span> instructions per second, which means that the latency of the FMLA (vector) instruction with arrangement specifier <code class="docutils literal notranslate"><span class="pre">4S</span></code> is approximately <span class="math notranslate nohighlight">\(\frac{1}{1.16266 \times 10^{10}} \approx 8.6 \times 10^{-11}\)</span> seconds. Using a known clock frequency of 4.4 GHz, we computed the latency as <span class="math notranslate nohighlight">\(8.6 \times 10^{-11} \times 4.4 \times 10^9 = 0.3784\)</span> cycles.</p>
</section>
</section>
<section id="microkernel">
<h2>3.2 Microkernel<a class="headerlink" href="#microkernel" title="Link to this heading"></a></h2>
<p>For the second task we were implementing a microkernel to execute a matrix multiplication for matrices with the dimensions:</p>
<ol class="arabic simple">
<li><p>Matrix A: 16 x 1</p></li>
<li><p>Matrix B: 1 x 6</p></li>
<li><p>Matrix C: 16 x 6</p></li>
</ol>
<section id="neon-microkernel">
<h3>3.2.1 Neon Microkernel<a class="headerlink" href="#neon-microkernel" title="Link to this heading"></a></h3>
<p>We developed three different versions of this microkernel in order to optimize its performance.</p>
<p>In the <strong>first version</strong> we:</p>
<ol class="arabic simple">
<li><p>Load matrix A (16 x 1)</p></li>
<li><p>Load three columns (1 x 1) of matrix B</p></li>
<li><p>Load matrix C (16 x 6)</p></li>
</ol>
<p>In the <strong>second version</strong> we:</p>
<ol class="arabic simple">
<li><p>Load matrix A (16 x 1)</p></li>
<li><p>Load one column of matrix B</p></li>
<li><p>Load matrix C (16 x 6)</p></li>
</ol>
<p>In the <strong>third version</strong> we:</p>
<ol class="arabic simple">
<li><p>Load matrix A (16 x 1)</p></li>
<li><p>Load one column of matrix B</p></li>
<li><p>Load one column of matrix C (16 x 1)</p></li>
</ol>
</section>
<section id="testing-and-benchmarking">
<h3>3.2.2 Testing and Benchmarking<a class="headerlink" href="#testing-and-benchmarking" title="Link to this heading"></a></h3>
<p>To test and compare our versions with one another we:</p>
<ol class="arabic simple">
<li><p>implemented a microkernel that would give us a visual indication of the results</p></li>
<li><p>implemented a test using Catch2 to test the correctness of our implementations</p></li>
<li><p>implemented a microbenchmark that would calculate the GFLOPs for each of the three versions</p></li>
</ol>
<p>The GFLOPs were calculated using the following formula:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">GFLOPs calculations</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">138</span><span class="w">                              </span><span class="mi">16</span><span class="w"> </span><span class="p">);</span>
<span class="linenos">139</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">140</span><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="linenos">141</span><span class="w">        </span><span class="n">elapsedTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span><span class="n">l_end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l_start_time</span><span class="w"> </span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>For each version we would perform <code class="docutils literal notranslate"><span class="pre">50,000</span></code> iterations as a warmup to guarantee similar results for each execution of the benchmark.
Using this approach we obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">GFLOPs calculations</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Benchmarking V1 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.93595
Instructions per Second:   3.26981e+10
Estimated GFLOPS:   32.6981 GFLOPS/sec
-----------------------------------------------

Benchmarking V2 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.90291
Instructions per Second:   3.30702e+10
Estimated GFLOPS:   33.0702 GFLOPS/sec
-----------------------------------------------

Benchmarking V3 Matmul throughput ...
-----------------------------------------------
Measuring throughput for Instruction
Total time (s):   2.79132
Instructions per Second:   3.43923e+10
Estimated GFLOPS:   34.3923 GFLOPS/sec
-----------------------------------------------
</pre></div>
</div>
</div>
<p>The GLFOPs results indicate that with every version we obtained slightly better results, resulting in
about <code class="docutils literal notranslate"><span class="pre">1.7</span></code> GLOPs in difference comparing our best with our worst approach.</p>
</section>
</section>
<section id="loops">
<span id="id1"></span><h2>3.3 Loops<a class="headerlink" href="#loops" title="Link to this heading"></a></h2>
<p>In this task, we had to add loops to the matrix multiplication kernel which we wrote in the previous task. The goal was to enable the 16x6x1 kernel to be used for larger matrices.</p>
<p>The first step was to implement a loop in the K dimension, resulting in a 16x6x64 kernel. The loading and storing of matrix C was left unchanged. The relevant code is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">Looping matmul_16_6_1 over K dimension</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 67</span><span class="w">    </span><span class="c1">//  K loop counter</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#64</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">// set start of A</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="c1">// set start of B</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="c1">// init row count of B</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="nl">_k_loop:</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="no">q27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">122</span>
<span class="linenos">123</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">125</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">132</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k_loop</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">matmul_16_6_1</span></code> kernel mostly stayed the same, except that for each K loop, we now need to adjust the pointers to the input matrices A and B. At the end of each loop, we move the pointers to A to the next column by adding the given stride. In B, we need to move the pointer to the next row. Therefore, we jump by 4 Bytes (since we are using 32-bit floats) from the starting address of B. To keep jumping to the next row in each loop, we accumulate the offset of 4 Bytes in the register <code class="docutils literal notranslate"><span class="pre">x9</span></code>.</p>
<p>The second step was to implement a loop in the M dimension, resulting in a 64x6x64 kernel. To keep the code examples shorter, we exclude the K loop from the code snippets. The relevant code is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">First part of looping over M dimension</span><a class="headerlink" href="#id18" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">45</span><span class="w">    </span><span class="c1">// save base matrix pointers</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">48</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="w">    </span><span class="c1">// M loop counter</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span><span class="w"> </span><span class="c1">// 64/16 = 4 blocks</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="nl">_m_loop:</span>
<span class="linenos">54</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">55</span><span class="c1">// START matmul_16_6_64</span>
<span class="linenos">56</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">// LOAD MATRIX C</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">60</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">63</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">65</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">66</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">68</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">69</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">71</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">72</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">75</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">76</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">77</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">78</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">79</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">80</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">82</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">83</span>
<span class="linenos">84</span><span class="w">    </span><span class="c1">// K loop counter</span>
<span class="linenos">85</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="mi">#64</span>
<span class="linenos">86</span><span class="w">    </span><span class="c1">// set start of A</span>
<span class="linenos">87</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x15</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span>
<span class="linenos">88</span><span class="w">    </span><span class="c1">// set start of B</span>
<span class="linenos">89</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x16</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span>
<span class="linenos">90</span><span class="w">    </span><span class="c1">// init row count of B</span>
<span class="linenos">91</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x17</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span>
<span class="linenos">92</span><span class="nl">_k_loop:</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">Second part of looping over M dimension</span><a class="headerlink" href="#id19" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">153</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">154</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x14</span><span class="p">,</span><span class="w"> </span><span class="no">_k_loop</span>
<span class="linenos">155</span>
<span class="linenos">156</span><span class="w">    </span><span class="c1">// STORE MATRIX C</span>
<span class="linenos">157</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">159</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">160</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">162</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q4</span><span class="p">,</span><span class="w"> </span><span class="no">q5</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">164</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q6</span><span class="p">,</span><span class="w"> </span><span class="no">q7</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">169</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">170</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">173</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">174</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">175</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">177</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">179</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">180</span><span class="w">    </span><span class="nf">stp</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">183</span><span class="c1">// END matmul_16_6_64</span>
<span class="linenos">184</span><span class="c1">// ------------------------------------------</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="w">    </span><span class="c1">// increase A and C pointers for next block</span>
<span class="linenos">187</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span><span class="p">*</span><span class="mi">4</span>
<span class="linenos">188</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span><span class="p">*</span><span class="mi">4</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="w">    </span><span class="c1">// decrement m loop counter</span>
<span class="linenos">191</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">192</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">193</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">_m_loop</span>
</pre></div>
</div>
</div>
<p>The M loop needs only 4 iterations, since we are extending the kernel from 16 to 64 in the M dimension by dividing the M dimension into 4 blocks of 16 elements. At the end of the M loop, we move the pointers of A and C to the next block. We jump by 16 elements in the M dimension, which means adding 16*4 Bytes to the pointer of A and C.</p>
<p>The last step was to implement a loop in the N dimension, resulting in a 64x48x64 kernel. The relevant code is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">First part of looping over N dimension</span><a class="headerlink" href="#id20" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">49</span><span class="w">    </span><span class="c1">// set base matrix pointers</span>
<span class="linenos">50</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="w">    </span><span class="c1">// N loop counter</span>
<span class="linenos">54</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">#8</span><span class="w"> </span><span class="c1">// 48/6 = 8 blocks</span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="nl">_n_loop:</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">// M loop counter</span>
<span class="linenos">59</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span><span class="w"> </span><span class="c1">// 64/16 = 4 blocks</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="w">    </span><span class="c1">// set matrix pointers</span>
<span class="linenos">62</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x20</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="w"> </span><span class="c1">// C</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="nl">_m_loop:</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">Second part of looping over N dimension</span><a class="headerlink" href="#id21" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">205</span><span class="w">    </span><span class="c1">// decrement m loop counter</span>
<span class="linenos">206</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">208</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">_m_loop</span>
<span class="linenos">209</span><span class="c1">// END M LOOP</span>
<span class="linenos">210</span>
<span class="linenos">211</span><span class="w">    </span><span class="c1">// increase B and C pointers for next block</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">// (jump 6 columns) 6*x4, 6*x5</span>
<span class="linenos">213</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x22</span>
<span class="linenos">214</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x23</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="w">    </span><span class="c1">// decrement n loop counter</span>
<span class="linenos">217</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">218</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">219</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x19</span><span class="p">,</span><span class="w"> </span><span class="no">_n_loop</span>
<span class="linenos">220</span><span class="c1">// END N LOOP</span>
</pre></div>
</div>
</div>
<p>Since we are extending the kernel from 6 to 48 in the N dimension, we need to divide the N dimension into 8 blocks of 6 elements. This means that the loop will have 8 iterations. For each N loop, it is important to first reset the pointer of A to the original address. After each iteration, we need to move the pointers of B and C to the next block. To do this, we jump by elements in the N dimension, that is specifically 6 columns of B and C. We do this by adding 6 times the stride of B and C to the pointers.</p>
<section id="id2">
<h3>3.3.1 Testing and Benchmarking<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>For all three kernels we have written unit tests. To execute the tests, one first needs to compile the code by invoking <code class="docutils literal notranslate"><span class="pre">make</span></code> from within the <code class="docutils literal notranslate"><span class="pre">src/submissions/03_neon/03_loops</span></code> directory. This will create an executable that can be run with <code class="docutils literal notranslate"><span class="pre">./build/test</span></code>.</p>
<p>We also calculated the GFLOPs for each of these matrix multiplications.
To calculate them we followed the simple formula:</p>
<div class="math notranslate nohighlight">
\[M \cdot N \cdot K \cdot \text{Ops Per FMLA}\]</div>
<p>The results that we obtained were:</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">GFLOPs calculations for MatMuls</span><a class="headerlink" href="#id22" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking Matmul_16_6_64 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.89248
<span class="linenos"> 5</span>Instructions per Second:   1.29861e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   129.861 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking Matmul_64_6_64 Matmul throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.84635
<span class="linenos">13</span>Instructions per Second:   1.33106e+11
<span class="linenos">14</span>Estimated GFLOPS:   133.106 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking Matmul_64_48_64 Matmul throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for Instruction
<span class="linenos">20</span>Total time (s):   1.49743
<span class="linenos">21</span>Instructions per Second:   1.31297e+11
<span class="linenos">22</span>Estimated GFLOPS:   131.297 GFLOPS/sec
<span class="linenos">23</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Our results indicate that the number of GFLOPs is very consistent, even when scaling the size of our matrix.</p>
</section>
</section>
<section id="simd-lanes">
<h2>3.4 SIMD Lanes<a class="headerlink" href="#simd-lanes" title="Link to this heading"></a></h2>
<p>For this task we were supposed to create two kernels, that should be able
to function, even if we don’t have a multiple of 4 for the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension.
We created several versions for both:</p>
<ol class="arabic simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">M=14</span></code>, <code class="docutils literal notranslate"><span class="pre">N=6</span></code> and <code class="docutils literal notranslate"><span class="pre">K=64</span></code>, and</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">M=15</span></code>, <code class="docutils literal notranslate"><span class="pre">N=6</span></code> and <code class="docutils literal notranslate"><span class="pre">K=64</span></code></p></li>
</ol>
<section id="matmul-14-6-64">
<h3>3.4.1 Matmul_14_6_64<a class="headerlink" href="#matmul-14-6-64" title="Link to this heading"></a></h3>
<p>For the case <code class="docutils literal notranslate"><span class="pre">M=14</span></code> we considered four different versions:</p>
<p>Our <strong>first approach</strong> was to use two loops. The first loop was used to calculate
a (12 x 64) block of matrix C. That means, we would load 12 column elements of matrix A.
The second loop was then used to calculate the remaining (2 x 64) block of matrix C.</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">Second loop for the (2 x 64) matrix calculation</span><a class="headerlink" href="#id23" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">157</span><span class="nl">_k2_loop:</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">159</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d24</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w">   </span><span class="c1">// 2 values</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">162</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">169</span>
<span class="linenos">170</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">173</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">177</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">181</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">182</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">183</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">184</span><span class="w">    </span>
<span class="linenos">185</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">186</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">187</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">188</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">191</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">192</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">193</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">194</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">195</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">198</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">199</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">200</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k2_loop</span>
</pre></div>
</div>
</div>
<p>The <strong>second approach</strong> was to use a single loop. We would load the whole matrix C, and matrix A
column-wise using one <code class="docutils literal notranslate"><span class="pre">ldp</span> <span class="pre">qXX,</span> <span class="pre">qXX,</span> <span class="pre">[x7]</span></code>, one <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">qXX,</span> <span class="pre">[x7,</span> <span class="pre">#32]</span></code> and one <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">dXX,</span> <span class="pre">[x7,</span> <span class="pre">#48]</span></code> instruction.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">Calculate matrix C with a single loop using four loads</span><a class="headerlink" href="#id24" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 86</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 values</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values - possible memory leak </span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">133</span>
<span class="linenos">134</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">140</span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">143</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">144</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>Our <strong>third approach</strong> was again to use a single loop. But this time we would load matrix A
column-wise using two <code class="docutils literal notranslate"><span class="pre">ldp</span> <span class="pre">qXX,</span> <span class="pre">qXX,</span> <span class="pre">[x7]</span></code> instructions and then set the last two elements
to zero using <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[2],</span> <span class="pre">wzr</span></code> and <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[3],</span> <span class="pre">wzr</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">Calculate matrix C with a single loop using <code class="docutils literal notranslate"><span class="pre">ldp</span></code> loads</span><a class="headerlink" href="#id25" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 88</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="no">q27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values - possible memory leak</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">136</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">140</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">141</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">143</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">144</span>
<span class="linenos">145</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">146</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">147</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">148</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>In our <strong>fourth approach</strong> we simply copied the second version and changed
our loads for matrix A and C. We used <code class="docutils literal notranslate"><span class="pre">ld1</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ldp</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">Calculate matrix C with a single loop and <code class="docutils literal notranslate"><span class="pre">ld1</span></code> loads</span><a class="headerlink" href="#id26" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 73</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v24.4s-v27.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#48</span><span class="p">]</span><span class="w"> </span><span class="c1">// 2 values</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">122</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>When benchmarking our approaches we obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for matmul_14_6_64 approaches</span><a class="headerlink" href="#id27" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1_Matmul_14_6_64 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   2.54314
<span class="linenos"> 5</span>Instructions per Second:   8.45568e+10
<span class="linenos"> 6</span>Estimated GFLOPS:   84.5568 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2_Matmul_14_6_64 throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.88243
<span class="linenos">13</span>Instructions per Second:   1.14235e+11
<span class="linenos">14</span>Estimated GFLOPS:   114.235 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
<span class="linenos">16</span>
<span class="linenos">17</span>Benchmarking V3_Matmul_14_6_64 throughput ...
<span class="linenos">18</span>-----------------------------------------------
<span class="linenos">19</span>Measuring throughput for Instruction
<span class="linenos">20</span>Total time (s):   2.08544
<span class="linenos">21</span>Instructions per Second:   1.03115e+11
<span class="linenos">22</span>Estimated GFLOPS:   103.115 GFLOPS/sec
<span class="linenos">23</span>-----------------------------------------------
<span class="linenos">24</span>
<span class="linenos">25</span>Benchmarking V4_Matmul_14_6_64 throughput ...
<span class="linenos">26</span>-----------------------------------------------
<span class="linenos">27</span>Measuring throughput for Instruction
<span class="linenos">28</span>Total time (s):   1.89444
<span class="linenos">29</span>Instructions per Second:   1.13511e+11
<span class="linenos">30</span>Estimated GFLOPS:   113.511 GFLOPS/sec
<span class="linenos">31</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>The results indicate that the version with three different loads performed
best, with an increase of about <code class="docutils literal notranslate"><span class="pre">10</span> <span class="pre">GFLOPs</span></code>. The switch from <code class="docutils literal notranslate"><span class="pre">ldp</span></code> to <code class="docutils literal notranslate"><span class="pre">ld1</span></code> however, didn’t show
any significant changes in the number of GFLOPs.</p>
</section>
<section id="matmul-15-6-64">
<h3>3.4.2 Matmul_15_6_64<a class="headerlink" href="#matmul-15-6-64" title="Link to this heading"></a></h3>
<p>For the case <code class="docutils literal notranslate"><span class="pre">M=15</span></code> we considered three different versions:</p>
<p>For our <strong>first approach</strong> we again considered two loops. Again, the first loop was used to calculate
a (12 x 64) block of matrix C.
The second loop was then used to calculate the remaining (3 x 64) block of matrix C.</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">Second loop for the (3 x 64) matrix calculation</span><a class="headerlink" href="#id28" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">211</span><span class="nl">_k2_loop:</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">213</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">d24</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w">   </span><span class="c1">// 2 values</span>
<span class="linenos">214</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#8</span><span class="p">]</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">217</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">218</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">219</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s1</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s1</span>
<span class="linenos">220</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">221</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">222</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">223</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">224</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s3</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s3</span>
<span class="linenos">225</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">226</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">227</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">228</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">229</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s5</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s5</span>
<span class="linenos">230</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">231</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">232</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">233</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">234</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s7</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s7</span>
<span class="linenos">235</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">236</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">237</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">238</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v8.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">239</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s9</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s9</span>
<span class="linenos">240</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">241</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">242</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">243</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.2s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">244</span><span class="w">    </span><span class="nf">fmadd</span><span class="w"> </span><span class="no">s11</span><span class="p">,</span><span class="w"> </span><span class="no">s25</span><span class="p">,</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="no">s11</span>
<span class="linenos">245</span>
<span class="linenos">246</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">247</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">248</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">249</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">250</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">251</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">254</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">255</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">256</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k2_loop</span>
</pre></div>
</div>
</div>
<p>In the <strong>second approach</strong> we use one loop. We load matrix A column-wise using two
two <code class="docutils literal notranslate"><span class="pre">ldp</span> <span class="pre">qXX,</span> <span class="pre">qXX,</span> <span class="pre">[x7]</span></code> instructions and then set the last element
to zero using <code class="docutils literal notranslate"><span class="pre">mov</span> <span class="pre">v27.s[3],</span> <span class="pre">wzr</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">Calculate matrix C with a single loop using <code class="docutils literal notranslate"><span class="pre">ldp</span></code> loads</span><a class="headerlink" href="#id29" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 99</span><span class="nl">_k1_loop:</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q24</span><span class="p">,</span><span class="w"> </span><span class="no">q25</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">ldp</span><span class="w"> </span><span class="no">q26</span><span class="p">,</span><span class="w"> </span><span class="no">q27</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#32</span><span class="p">]</span><span class="w"> </span><span class="c1">// 4 + 4 values - possible memory leak</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">129</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">133</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">136</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">140</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">141</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">142</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">143</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">144</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">145</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">146</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">149</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">150</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">151</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">152</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">153</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">156</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">157</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">158</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>In the <strong>third approach</strong> we again changed the load instructions from <code class="docutils literal notranslate"><span class="pre">ldp</span></code> to
<code class="docutils literal notranslate"><span class="pre">ld1</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">Calculate matrix C with a single loop using <code class="docutils literal notranslate"><span class="pre">ld1</span></code> loads</span><a class="headerlink" href="#id30" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 81</span><span class="nl">_k1_loop:</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="c1">// load column of A</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v24.4s-v27.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">v27.s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="no">wzr</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="c1">// B: COLUMN 0</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 88</span><span class="w">    </span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="c1">// B: COLUMN 1</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">// B: COLUMN 2</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">fmla</span><span class="w">  </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">107</span><span class="w">    </span><span class="c1">// B: COLUMN 3</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">110</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">113</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">114</span><span class="w">    </span><span class="c1">// B: COLUMN 4</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">121</span><span class="w">    </span><span class="c1">// B: COLUMN 5</span>
<span class="linenos">122</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos">123</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">s29</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos">124</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v24.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">125</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v25.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">126</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v26.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">fmla</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v27.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v29.s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">// move to next column of A</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">131</span><span class="w">    </span><span class="c1">// move to next row of B</span>
<span class="linenos">132</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">133</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">// decrement loop counter</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">138</span><span class="w">    </span><span class="c1">// check if loop counter is zero</span>
<span class="linenos">139</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_k1_loop</span>
</pre></div>
</div>
</div>
<p>Again, we performed some benchmarks:</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for matmul_15_6_64 approaches</span><a class="headerlink" href="#id31" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">41</span>Benchmarking V1_Matmul_15_6_64 throughput ...
<span class="linenos">42</span>-----------------------------------------------
<span class="linenos">43</span>Measuring throughput for Instruction
<span class="linenos">44</span>Total time (s):   2.80305
<span class="linenos">45</span>Instructions per Second:   8.21963e+10
<span class="linenos">46</span>Estimated GFLOPS:   82.1963 GFLOPS/sec
<span class="linenos">47</span>-----------------------------------------------
<span class="linenos">48</span>
<span class="linenos">49</span>Benchmarking V2_Matmul_15_6_64 throughput ...
<span class="linenos">50</span>-----------------------------------------------
<span class="linenos">51</span>Measuring throughput for Instruction
<span class="linenos">52</span>Total time (s):   2.18569
<span class="linenos">53</span>Instructions per Second:   1.05413e+11
<span class="linenos">54</span>Estimated GFLOPS:   105.413 GFLOPS/sec
<span class="linenos">55</span>-----------------------------------------------
<span class="linenos">56</span>
<span class="linenos">57</span>Benchmarking V3_Matmul_15_6_64 throughput ...
<span class="linenos">58</span>-----------------------------------------------
<span class="linenos">59</span>Measuring throughput for Instruction
<span class="linenos">60</span>Total time (s):   2.18658
<span class="linenos">61</span>Instructions per Second:   1.0537e+11
<span class="linenos">62</span>Estimated GFLOPS:   105.37 GFLOPS/sec
<span class="linenos">63</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Similar to the benchmarks for the <code class="docutils literal notranslate"><span class="pre">matmul_14_6_64</span></code> the approach with the single loop
performs much better than the other approach. This time, we even gain about
<code class="docutils literal notranslate"><span class="pre">23</span> <span class="pre">GFLOPs</span></code> with this approach.</p>
</section>
<section id="generic-approach">
<span id="generic-kernel"></span><h3>3.4.3 Generic Approach<a class="headerlink" href="#generic-approach" title="Link to this heading"></a></h3>
<p>Simply as a proof of concept we also implemented a generic approach for the <code class="docutils literal notranslate"><span class="pre">matmul_14_6_64</span></code> and <code class="docutils literal notranslate"><span class="pre">matmul_15_6_64</span></code> kernels. This kernel works for any <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>. The idea is to write specific kernels for <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">...,</span> <span class="pre">8</span></code>. We then divide M by 8 (shift right by 3) and use that to loop the kernel for <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">=</span> <span class="pre">8</span></code>. Basically we split the M dimension into blocks of 8 elements and compute the result using a <code class="docutils literal notranslate"><span class="pre">matmul_8_6_64</span></code> kernel. If there is a remainder, it is <code class="docutils literal notranslate"><span class="pre">&gt;=1</span> <span class="pre">and</span> <span class="pre">&lt;=7</span></code>, which we handle with specific kernels. The selection of the specific kernels is done using a jump table.</p>
<p>We also benchmarked the performance of this <strong>generic kernel</strong>:</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_M_6_64</span></code> (M = 14) approach</span><a class="headerlink" href="#id32" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span>Benchmarking Matmul_M_6_64 M=14 throughput ...
<span class="linenos">34</span>-----------------------------------------------
<span class="linenos">35</span>Measuring throughput for Instruction
<span class="linenos">36</span>Total time (s):   2.4066
<span class="linenos">37</span>Instructions per Second:   8.93543e+10
<span class="linenos">38</span>Estimated GFLOPS:   89.3543 GFLOPS/sec
<span class="linenos">39</span>-----------------------------------------------
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for <code class="docutils literal notranslate"><span class="pre">matmul_M_6_64</span></code> (M = 15) approach</span><a class="headerlink" href="#id33" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos">65</span>Benchmarking Matmul_M_6_64 M=15 throughput ...
<span class="linenos">66</span>-----------------------------------------------
<span class="linenos">67</span>Measuring throughput for Instruction
<span class="linenos">68</span>Total time (s):   3.68161
<span class="linenos">69</span>Instructions per Second:   6.25814e+10
<span class="linenos">70</span>Estimated GFLOPS:   62.5814 GFLOPS/sec
<span class="linenos">71</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Compared to our other approaches our obtained GFLOPs are slightly worse, losing
about <code class="docutils literal notranslate"><span class="pre">30</span> <span class="pre">GFLOPs</span></code> to our best approach for the <code class="docutils literal notranslate"><span class="pre">matmul_14_6_64</span></code> and about
<code class="docutils literal notranslate"><span class="pre">40</span> <span class="pre">GFLOPs</span></code> to our best approach for the <code class="docutils literal notranslate"><span class="pre">matmul_15_6_64</span></code>.</p>
</section>
</section>
<section id="accumulator-block-shapes">
<h2>3.5 Accumulator Block Shapes<a class="headerlink" href="#accumulator-block-shapes" title="Link to this heading"></a></h2>
<p>In this task we were supposed to implement a microkernel that computes C+=AB for M=64, N=64 and K=64. Recalling our <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel, we only need to change the N dimension to 64. This kernel uses the <code class="docutils literal notranslate"><span class="pre">matmul_16_6_64</span></code> internally, which we changed to <code class="docutils literal notranslate"><span class="pre">matmul_16_4_64</span></code>. Changing N from 6 to 4 allows us to divide the N dimension into 16 blocks of 4 elements. N = 8 was not suitable, as we ran into issues with the number of available SIMD lanes. We do not think it is necessary to show the code for this kernel, as it is very similar to the <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel. The only difference is that we removed the logic for 2 of the 6 columns and increased the loop counter constant.</p>
<p>Benchmarking this kernel we obtained the following results:</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for matmul_64_64_64 approaches</span><a class="headerlink" href="#id34" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1 Matmul throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.27442
<span class="linenos"> 5</span>Instructions per Second:   1.23418e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   123.418 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2 Matmul throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.246
<span class="linenos">13</span>Instructions per Second:   1.26233e+11
<span class="linenos">14</span>Estimated GFLOPS:   126.233 GFLOPS/sec
<span class="linenos">15</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>V1 is the first version which we obtained by converting our best performing <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel. Trying to squeeze out more performance, we made some minor changes to the computations of the strides (as shown below). We also removed loads and stores of callee-saved registers that were not used. This resulted in a performance increase of about 2-3 GFLOPs in V2 across multiple runs.</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">Naive stride calculations</span><a class="headerlink" href="#id35" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// lda</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldb</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldc</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#4</span>
<span class="linenos">46</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x22</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldb * 4 columns</span>
<span class="linenos">47</span><span class="w">    </span><span class="nf">mul</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// ldc * 4 columns</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">Optimized stride calculations</span><a class="headerlink" href="#id36" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">37</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">38</span><span class="w">    </span><span class="c1">// *4 = lsl #2</span>
<span class="linenos">39</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// lda</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x22</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb * 4 columns</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc * 4 columns</span>
</pre></div>
</div>
</div>
</section>
<section id="batch-reduce-gemm">
<span id="id3"></span><h2>3.6 Batch-Reduce GEMM<a class="headerlink" href="#batch-reduce-gemm" title="Link to this heading"></a></h2>
<p>Based on the previous tasks, we are now implementing a batch-reduce GEMM kernel.
The goal is to implement a kernel that computes <span class="math notranslate nohighlight">\(C+=\sum_i A_i B_i\)</span> for M=64, N=48 and K=64 matrices.
The kernel should be able to handle batches of matrices.
For now we are only implementing the case where the batch size is 16.</p>
<p>Similar to the previous tasks we implemented several versions of this kernel to optimize the performance.</p>
<p>In our <strong>first version</strong> we simply used our <code class="docutils literal notranslate"><span class="pre">matmul_64_48_64</span></code> kernel from our <a class="reference internal" href="#loops"><span class="std std-ref">loops</span></a> task and looped 16 times around that kernel.
Key points that we needed to consider were the following:</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">Setting the batch counter</span><a class="headerlink" href="#id37" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">56</span><span class="w">    </span><span class="c1">// Batch counter</span>
<span class="linenos">57</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="nl">_n_batch:</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text">Jumping to the next matrix A and B in the batch</span><a class="headerlink" href="#id38" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">230</span><span class="w">    </span><span class="c1">// next A matrix</span>
<span class="linenos">231</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">232</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w">     </span><span class="c1">// A</span>
<span class="linenos">233</span>
<span class="linenos">234</span><span class="w">    </span><span class="c1">// next B matrix</span>
<span class="linenos">235</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">236</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x20</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w">    </span><span class="c1">// B</span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="w">    </span><span class="c1">// restore Pointer for matrix C</span>
<span class="linenos">239</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x21</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span><span class="w">    </span><span class="c1">// C</span>
<span class="linenos">240</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x10</span><span class="p">,</span><span class="w"> </span><span class="no">x21</span><span class="w">   </span><span class="c1">// C</span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">243</span>
<span class="linenos">244</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">_n_batch</span>
</pre></div>
</div>
</div>
<p>In our <strong>second version</strong> we made some optimizations to the kernel.
The changes we made were:</p>
<div class="literal-block-wrapper docutils container" id="id39">
<div class="code-block-caption"><span class="caption-text">Replacing <code class="docutils literal notranslate"><span class="pre">MUL</span></code>’s with <code class="docutils literal notranslate"><span class="pre">LSL</span></code>’s</span><a class="headerlink" href="#id39" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">39</span><span class="w">    </span><span class="c1">// multiply strides with float size</span>
<span class="linenos">40</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// lda in bytes</span>
<span class="linenos">41</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldb in bytes</span>
<span class="linenos">42</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// ldc in bytes</span>
<span class="linenos">43</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// br_stride_a in bytes</span>
<span class="linenos">44</span><span class="w">    </span><span class="nf">lsl</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// br_stride_b in bytes</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-text">Replacing all <code class="docutils literal notranslate"><span class="pre">LDP</span></code>’s with <code class="docutils literal notranslate"><span class="pre">LD1</span></code>’s and <code class="docutils literal notranslate"><span class="pre">STP</span></code>’s with <code class="docutils literal notranslate"><span class="pre">ST1</span></code>’s</span><a class="headerlink" href="#id40" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">78</span><span class="w">    </span><span class="c1">// LOAD MATRIX C</span>
<span class="linenos">79</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x10</span>
<span class="linenos">80</span><span class="w">    </span><span class="c1">// first column</span>
<span class="linenos">81</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">82</span><span class="w">    </span><span class="c1">// second column</span>
<span class="linenos">83</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">84</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">85</span><span class="w">    </span><span class="c1">// third column</span>
<span class="linenos">86</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">87</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">88</span><span class="w">    </span><span class="c1">// fourth column</span>
<span class="linenos">89</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">90</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">91</span><span class="w">    </span><span class="c1">// fifth column</span>
<span class="linenos">92</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">93</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
<span class="linenos">94</span><span class="w">    </span><span class="c1">// sixth column</span>
<span class="linenos">95</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos">96</span><span class="w">    </span><span class="nf">ld1</span><span class="w"> </span><span class="p">{</span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="no">x12</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>These optimizations resulted in a performance increase of about <code class="docutils literal notranslate"><span class="pre">3-4</span> <span class="pre">GFLOPs</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-text">Benchmarking results for the batch-reduce GEMM kernels</span><a class="headerlink" href="#id41" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking V1_Matmul_64_48_64_16 throughput ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for Instruction
<span class="linenos"> 4</span>Total time (s):   1.22446
<span class="linenos"> 5</span>Instructions per Second:   1.28453e+11
<span class="linenos"> 6</span>Estimated GFLOPS:   128.453 GFLOPS/sec
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking V2_Matmul_64_48_64_16 throughput ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for Instruction
<span class="linenos">12</span>Total time (s):   1.19946
<span class="linenos">13</span>Instructions per Second:   1.31131e+11
<span class="linenos">14</span>Estimated GFLOPS:   131.131 GFLOPS/sec
</pre></div>
</div>
</div>
</section>
<section id="transposition">
<span id="id4"></span><h2>3.7 Transposition<a class="headerlink" href="#transposition" title="Link to this heading"></a></h2>
<p>In this task we were looking at how to transpose a given <code class="docutils literal notranslate"><span class="pre">8x8</span> <span class="pre">matrix</span></code> using assembly.
Our approach was to firstly look at the <code class="docutils literal notranslate"><span class="pre">4x4</span></code> case.</p>
<section id="transposition-implementation">
<h3>3.7.1 Transposition Implementation<a class="headerlink" href="#transposition-implementation" title="Link to this heading"></a></h3>
<p>We would first load the all 4 columns of matrix A using <code class="docutils literal notranslate"><span class="pre">ldr</span> <span class="pre">qX,</span> <span class="pre">[x0]</span></code> to have the whole matrix in our registers.
The second step would be to transpose the matrix:</p>
<div class="literal-block-wrapper docutils container" id="id42">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">trans_4_4</span></code> implementation</span><a class="headerlink" href="#id42" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos">56</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">57</span><span class="cm">    * Part 2.1:</span>
<span class="linenos">58</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">59</span><span class="cm">    */</span>
<span class="linenos">60</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">61</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">64</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">65</span>
<span class="linenos">66</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">67</span><span class="cm">    * Part 2.2:</span>
<span class="linenos">68</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">69</span><span class="cm">    */</span>
<span class="linenos">70</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">    </span><span class="c1">// B &quot;column&quot; 0</span>
<span class="linenos">71</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">    </span><span class="c1">// B &quot;column&quot; 1</span>
<span class="linenos">72</span>
<span class="linenos">73</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">   </span><span class="c1">// B &quot;column&quot; 2</span>
<span class="linenos">74</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">   </span><span class="c1">// B &quot;column&quot; 3</span>
</pre></div>
</div>
</div>
<p>The idea of <code class="docutils literal notranslate"><span class="pre">trn1</span></code> and <code class="docutils literal notranslate"><span class="pre">trn2</span></code> were to prepare the elements for each column in such a way, that
we could then leverage the new structure using <code class="docutils literal notranslate"><span class="pre">zip1</span></code> and <code class="docutils literal notranslate"><span class="pre">zip2</span></code>.</p>
<p>Now, looking at the <code class="docutils literal notranslate"><span class="pre">8x8</span> <span class="pre">matrix</span></code> our initial approach would be very simple:</p>
<a class="reference internal image-reference" href="../_images/submatrices.png"><img alt="Matrix divided in 4 quadrants" src="../_images/submatrices.png" style="width: 400px;" />
</a>
<p>We would separate our transposition task in 4 subtasks.
Each of the 4 <code class="docutils literal notranslate"><span class="pre">4x4</span> <span class="pre">submatrices</span></code> would be transposed using our <code class="docutils literal notranslate"><span class="pre">trans_4_4</span></code> kernel.</p>
<ol class="arabic simple">
<li><p>The upper left matrix (in the image A) would be transposed and stored at the loading position.</p></li>
<li><p>The upper right matrix (in the image B) would be transposed and stored at the “loading” position of the bottom left matrix.</p></li>
<li><p>The bottom left matrix (in the image C) would be transposed and stored at the “loading” position of the upper right matrix.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-text">loading, transposition and storing of upper right and bottom left matrix</span><a class="headerlink" href="#id43" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 89</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 90</span><span class="cm">    * Part 1.2:</span>
<span class="linenos"> 91</span><span class="cm">    * Load 4x4 block of A (Left bottom, top right).</span>
<span class="linenos"> 92</span><span class="cm">    */</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">100</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">102</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">103</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">105</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">    </span><span class="c1">// Right top</span>
<span class="linenos">108</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="c1">// A</span>
<span class="linenos">109</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="c1">// B</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">113</span><span class="w">    </span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q12</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">116</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q13</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q14</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">119</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q15</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x4</span><span class="p">]</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">123</span><span class="cm">    * Part 2.1:</span>
<span class="linenos">124</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">125</span><span class="cm">    */</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">// Left Bottom</span>
<span class="linenos">127</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">128</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos">131</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="w">    </span><span class="c1">// Right Top</span>
<span class="linenos">134</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">135</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v12.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v14.4s</span>
<span class="linenos">138</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v13.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v15.4s</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">141</span><span class="cm">    * Part 2.2:</span>
<span class="linenos">142</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos">143</span><span class="cm">    */</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">// Left Bottom</span>
<span class="linenos">145</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v8.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">    </span>
<span class="linenos">146</span><span class="w">    </span><span class="no">zip1</span><span class="w"> </span><span class="no">v9.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">    </span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v10.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span><span class="w">   </span>
<span class="linenos">149</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v11.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span><span class="w">   </span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">    </span><span class="c1">// Right Top</span>
<span class="linenos">152</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v20.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="w"> </span>
<span class="linenos">153</span><span class="w">    </span><span class="no">zip1</span><span class="w"> </span><span class="no">v21.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span><span class="w"> </span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v22.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v17.4s</span><span class="w"> </span>
<span class="linenos">156</span><span class="w">    </span><span class="no">zip2</span><span class="w"> </span><span class="no">v23.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v19.4s</span>
<span class="linenos">157</span>
<span class="linenos">158</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos">159</span><span class="cm">    * Part 3:</span>
<span class="linenos">160</span><span class="cm">    * Store 4x4 block of Submatrix A&#39;&#39;&#39; into A&#39;&#39;.</span>
<span class="linenos">161</span><span class="cm">    */</span>
<span class="linenos">162</span><span class="w">    </span><span class="c1">// Left Bottom (values from right top)</span>
<span class="linenos">163</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">164</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#16</span>
<span class="linenos">165</span>
<span class="linenos">166</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q20</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">167</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">168</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q21</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">169</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">170</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q22</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">171</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">172</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q23</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">173</span>
<span class="linenos">174</span><span class="w">    </span><span class="c1">// Right top (values from left bottom)</span>
<span class="linenos">175</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">176</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="mi">#128</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">179</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">180</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">181</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">182</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q10</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
<span class="linenos">183</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos">184</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q11</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<ol class="arabic simple" start="4">
<li><p>The bottom right matrix (in the image D) would be transposed and stored at the loading position.</p></li>
</ol>
<p>To optimize our first version we removed the PCS to all registers that we did not use.
We also wrote our kernel in a more compact manner.</p>
<div class="literal-block-wrapper docutils container" id="id44">
<div class="code-block-caption"><span class="caption-text">Optimized second transposition kernel</span><a class="headerlink" href="#id44" title="Link to this code"></a></div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 40</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// n loop</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="nl">n_loop:</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#2</span><span class="w"> </span><span class="c1">// m loop</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="nl">m_loop:</span>
<span class="linenos"> 47</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 48</span><span class="cm">     * Part 1:</span>
<span class="linenos"> 49</span><span class="cm">     * Transpose 4x4 block.</span>
<span class="linenos"> 50</span><span class="cm">     */</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q0</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="nf">ldr</span><span class="w"> </span><span class="no">q3</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x7</span><span class="p">]</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 66</span><span class="cm">    * Part 2.1:</span>
<span class="linenos"> 67</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos"> 68</span><span class="cm">    */</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="nf">trn1</span><span class="w"> </span><span class="no">v5.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v0.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v2.4s</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="nf">trn2</span><span class="w"> </span><span class="no">v7.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v1.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v3.4s</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 76</span><span class="cm">    * Part 2.2:</span>
<span class="linenos"> 77</span><span class="cm">    * Transpose 4x4 block.</span>
<span class="linenos"> 78</span><span class="cm">    */</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v16.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="nf">zip1</span><span class="w"> </span><span class="no">v17.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v18.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v4.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v5.4s</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="nf">zip2</span><span class="w"> </span><span class="no">v19.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v6.4s</span><span class="p">,</span><span class="w"> </span><span class="no">v7.4s</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 86</span><span class="cm">    * Part 3:</span>
<span class="linenos"> 87</span><span class="cm">    * Store 4x4 block of A into B.</span>
<span class="linenos"> 88</span><span class="cm">    */</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q16</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q17</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q18</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="nf">str</span><span class="w"> </span><span class="no">q19</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">x8</span><span class="p">]</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">// Jump 4 rows in A</span>
<span class="linenos">101</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x25</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">// Jump 4 columns in B</span>
<span class="linenos">104</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x27</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">107</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">m_loop</span>
<span class="linenos">108</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">// Restore Pointer for A and B</span>
<span class="linenos">111</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span>
<span class="linenos">112</span><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="linenos">113</span>
<span class="linenos">114</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x26</span>
<span class="linenos">115</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x25</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x4</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span>
<span class="linenos">118</span><span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="mi">#1</span>
<span class="linenos">121</span><span class="w">    </span><span class="nf">cbnz</span><span class="w"> </span><span class="no">x9</span><span class="p">,</span><span class="w"> </span><span class="no">n_loop</span>
</pre></div>
</div>
</div>
</section>
<section id="performance-measuring">
<h3>3.7.2 Performance Measuring<a class="headerlink" href="#performance-measuring" title="Link to this heading"></a></h3>
<p>We also wanted to know the performance of our transposition kernel, which in
our case would be the loading and storing of elements.</p>
<div class="literal-block-wrapper docutils container" id="id45">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">trans_8_8</span></code> performance in <code class="docutils literal notranslate"><span class="pre">GiB/s</span></code></span><a class="headerlink" href="#id45" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Benchmarking trans_neon_8_8 performance ...
<span class="linenos"> 2</span>-----------------------------------------------
<span class="linenos"> 3</span>Measuring throughput for transposition in GiB/s
<span class="linenos"> 4</span>Total time (s):   1.26545
<span class="linenos"> 5</span>Data movements per Second:   8.09199e+10
<span class="linenos"> 6</span>Estimated GiB/s:   80.9199 GiB/s
<span class="linenos"> 7</span>-----------------------------------------------
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Benchmarking v2_trans_neon_8_8 performance ...
<span class="linenos">10</span>-----------------------------------------------
<span class="linenos">11</span>Measuring throughput for transposition in GiB/s
<span class="linenos">12</span>Total time (s):   0.902975
<span class="linenos">13</span>Data movements per Second:   1.13403e+11
<span class="linenos">14</span>Estimated GiB/s:   113.403 GiB/s
<span class="linenos">15</span>-----------------------------------------------
</pre></div>
</div>
</div>
<p>Our results showed that we for our first version we are transferring about <code class="docutils literal notranslate"><span class="pre">80</span> <span class="pre">GiB/s</span></code>.
In our optimized version we <strong>increase</strong> this performance by roughly <code class="docutils literal notranslate"><span class="pre">33</span> <span class="pre">GiB/s</span></code>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="02_base.html" class="btn btn-neutral float-left" title="2. Base" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="04_code_gen.html" class="btn btn-neutral float-right" title="4. Code Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lucas Obitz, Luca-Philipp Grumbach.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>