

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5. Tensor Operation Backend &mdash; Machine Learning Compilers  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="mini_jit" href="../api/namespaces/mini_jit.html" />
    <link rel="prev" title="4. Code Generation" href="04_code_gen.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Machine Learning Compilers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Project Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/01_project_information.html">Machine Learning Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_overview/02_docu_setup.html">Documentation Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Submissions</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="01_assembly.html">1. Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_base.html">2. Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_neon.html">3. Neon</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_code_gen.html">4. Code Generation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Tensor Operation Backend</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#user-interface">5.1 User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#recursive-loops-over-primitives">5.2 Recursive Loops over Primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-benchmarking">5.3 Performance Benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shared-memory-parallelization">5.4 Shared Memory Parallelization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimization-passes">5.5 Optimization Passes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#primitive-identification">5.5.1 Primitive Identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#splitting-dimensions">5.5.2 Splitting Dimensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">5.5.3 Shared Memory Parallelization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-benchmarks">5.5.6 Performance Benchmarks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit.html">mini_jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_benchmarks.html">mini_jit::benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_converters.html">mini_jit::converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_einsum.html">mini_jit::einsum</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_instructions.html">mini_jit::instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_ir.html">mini_jit::ir</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_kernels.html">mini_jit::kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/namespaces/mini_jit_registers.html">mini_jit::registers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Machine Learning Compilers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">5. Tensor Operation Backend</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/submissions/05_tensor_op.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tensor-operation-backend">
<h1>5. Tensor Operation Backend<a class="headerlink" href="#tensor-operation-backend" title="Link to this heading"></a></h1>
<p>After experimenting with different neon implementations and developing kernels
for our gemm and brgemm, and most recently for the unary primitives, it is now time
to combine all of these kernels together in a backend.</p>
<section id="user-interface">
<h2>5.1 User Interface<a class="headerlink" href="#user-interface" title="Link to this heading"></a></h2>
<p>The first thing that we need for our backend is a common entry point.
Our common entry point is our <code class="docutils literal notranslate"><span class="pre">setup</span></code> function. Within the setup function we
parse a number of configuration parameters, from which the corresponding kernels and
primitives are constructed at runtime.</p>
<p>In our setup function, we check several things:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">error handling for dimensions and execution types</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">15</span><span class="w">                                                   </span><span class="n">std</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strides_out</span><span class="p">)</span>
<span class="linenos">16</span><span class="p">{</span>
<span class="linenos">17</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">18</span><span class="w">    </span><span class="c1">// Check the number of dimensions</span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">20</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dim_sizes</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strides_in0</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strides_in1</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strides_out</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
<span class="linenos">21</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">22</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dimension</span><span class="p">;</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">26</span><span class="w">    </span><span class="c1">// Check the number of prim exec types</span>
<span class="linenos">27</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">prim_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">count</span><span class="p">(</span><span class="n">exec_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">);</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">brgemm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prim_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="linenos">30</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">31</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_exec_type</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">33</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">gemm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prim_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">34</span><span class="w">    </span><span class="p">{</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">assigning configuration parameters to member variables</span><a class="headerlink" href="#id3" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">36</span><span class="p">}</span>
<span class="linenos">37</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">identity</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prim_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">38</span><span class="p">{</span>
<span class="linenos">39</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_exec_type</span><span class="p">;</span>
<span class="linenos">40</span><span class="p">}</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">43</span><span class="c1">// Check allowed data type</span>
<span class="linenos">44</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">45</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dtype</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dtype_t</span><span class="o">::</span><span class="n">fp32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">check data type and assign correct first and last touch, and main primitive</span><a class="headerlink" href="#id4" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">47</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_dtype</span><span class="p">;</span>
<span class="linenos">48</span><span class="p">}</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">51</span><span class="c1">// Check allowed primitive types</span>
<span class="linenos">52</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">53</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ptype_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allowed_first_touch_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ptype_t</span><span class="o">::</span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">relu</span><span class="p">};</span>
<span class="linenos">54</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ptype_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allowed_main_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ptype_t</span><span class="o">::</span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">identity</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">brgemm</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">gemm</span><span class="p">};</span>
<span class="linenos">55</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ptype_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allowed_last_touch_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ptype_t</span><span class="o">::</span><span class="n">none</span><span class="p">,</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">relu</span><span class="p">};</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">allowed_first_touch_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">allowed_first_touch_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">prim_first_touch</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allowed_first_touch_types</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">58</span><span class="p">{</span>
<span class="linenos">59</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_ptype</span><span class="p">;</span>
<span class="linenos">60</span><span class="p">}</span>
<span class="linenos">61</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">allowed_main_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">allowed_main_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">prim_main</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allowed_main_types</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">62</span><span class="p">{</span>
<span class="linenos">63</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_ptype</span><span class="p">;</span>
<span class="linenos">64</span><span class="p">}</span>
<span class="linenos">65</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">allowed_last_touch_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">allowed_last_touch_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">prim_last_touch</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allowed_last_touch_types</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">66</span><span class="p">{</span>
<span class="linenos">67</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">wrong_ptype</span><span class="p">;</span>
<span class="linenos">68</span><span class="p">}</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">71</span><span class="c1">// Assign member variables</span>
<span class="linenos">72</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">73</span><span class="n">m_dim_types</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dim_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">dim_types</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">find the first <code class="docutils literal notranslate"><span class="pre">prim</span></code> and <code class="docutils literal notranslate"><span class="pre">seq</span></code> position in <code class="docutils literal notranslate"><span class="pre">exec_types</span></code></span><a class="headerlink" href="#id5" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">114</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">115</span><span class="c1">// Find SHARED dimensions in exec types</span>
<span class="linenos">116</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">117</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_exec_types</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">118</span><span class="p">{</span>
<span class="linenos">119</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_exec_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">shared</span><span class="p">)</span>
<span class="linenos">120</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">121</span><span class="w">        </span><span class="n">m_shared_loop_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">122</span><span class="w">        </span><span class="n">m_shared_loop_sizes</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">123</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">124</span><span class="p">}</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">127</span><span class="c1">// Read PRIM dimensions using dim types (No Copy)</span>
<span class="linenos">128</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">129</span><span class="c1">// convert to int so negative values are allowed</span>
<span class="linenos">130</span><span class="kt">int</span><span class="w"> </span><span class="n">l_dim_types_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="linenos">131</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_dim_types_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
<span class="linenos">132</span><span class="p">{</span>
<span class="linenos">133</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_exec_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">)</span>
<span class="linenos">134</span><span class="w">    </span><span class="p">{</span>
</pre></div>
</div>
</div>
<p>We need to know the position of the first prim, to determine when we need to call the main kernel instead of recursively going deeper into the loop structure.
In other words, we traverse the first sequential loops and as soon as we reach the first primary dimension, we start calling the main kernel.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">assign the size of the <code class="docutils literal notranslate"><span class="pre">prim</span></code> dimensions according to the order in <code class="docutils literal notranslate"><span class="pre">dim_types</span></code></span><a class="headerlink" href="#id6" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 86</span><span class="n">m_dim_id_seq_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="n">m_dim_id_seq_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 88</span><span class="n">m_dim_id_sha_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 89</span><span class="n">m_dim_id_sha_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 90</span><span class="n">m_num_parallel_loops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 93</span><span class="c1">// Find first PRIM and SEQ dimensions in exec types</span>
<span class="linenos"> 94</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 95</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">exec_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">exec_types</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos"> 97</span><span class="p">{</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="n">m_id_first_primitive_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">exec_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">it</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="p">}</span>
<span class="linenos">100</span><span class="k">else</span>
<span class="linenos">101</span><span class="p">{</span>
<span class="linenos">102</span><span class="w">    </span><span class="n">m_id_first_primitive_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">103</span><span class="p">}</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">exec_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_types</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">seq</span><span class="p">);</span>
<span class="linenos">106</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">exec_types</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">107</span><span class="p">{</span>
<span class="linenos">108</span><span class="w">    </span><span class="n">m_id_first_seq_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">exec_types</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">it</span><span class="p">);</span>
<span class="linenos">109</span><span class="p">}</span>
<span class="linenos">110</span><span class="k">else</span>
<span class="linenos">111</span><span class="p">{</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">m_id_first_seq_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">assign the size of the <code class="docutils literal notranslate"><span class="pre">seq</span></code> dimensions according to the order in <code class="docutils literal notranslate"><span class="pre">dim_types</span></code></span><a class="headerlink" href="#id7" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">149</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">150</span><span class="w">            </span><span class="n">m_dim_id_prim_BR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">151</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">152</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">153</span><span class="p">}</span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">156</span><span class="c1">// Read SEQ and SHARED dimensions using dim types</span>
<span class="linenos">157</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">158</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">159</span><span class="p">{</span>
<span class="linenos">160</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_exec_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">seq</span><span class="p">)</span>
<span class="linenos">161</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">162</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">m</span><span class="p">)</span>
<span class="linenos">163</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">164</span><span class="w">            </span><span class="n">m_dim_id_seq_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">165</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">166</span><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">167</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">168</span><span class="w">            </span><span class="n">m_dim_id_seq_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>After checking all these things, we were then able to create our kernels accordingly.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">construct kernels based on assigned member variables</span><a class="headerlink" href="#id8" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">184</span><span class="w">            </span><span class="n">m_dim_id_sha_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">185</span><span class="w">            </span><span class="n">m_num_parallel_loops</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">186</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">187</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">188</span><span class="p">}</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">191</span><span class="c1">// Find M and N dimensions for dim_t::c (PRIM)</span>
<span class="linenos">192</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">193</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">identity</span><span class="p">)</span>
<span class="linenos">194</span><span class="p">{</span>
<span class="linenos">195</span><span class="w">    </span><span class="c1">// For unary operations with dim_t::c, treat the first primitive dimension as M and the second as N</span>
<span class="linenos">196</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="linenos">197</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">198</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_exec_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">c</span><span class="p">)</span>
<span class="linenos">199</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">200</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_strides_in0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">201</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">202</span><span class="w">                </span><span class="n">m_dim_id_prim_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">203</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">204</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">205</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">206</span><span class="w">                </span><span class="n">m_dim_id_prim_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">207</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">208</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">209</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">210</span><span class="p">}</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">213</span><span class="c1">// Check for Transposition</span>
<span class="linenos">214</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">215</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_id_prim_M</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="linenos">216</span><span class="p">{</span>
<span class="linenos">217</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_stride_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in0</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">];</span>
<span class="linenos">218</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_stride_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_out</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">];</span>
<span class="linenos">219</span><span class="w">    </span><span class="c1">// set transpose flag to true if the strides are different</span>
<span class="linenos">220</span><span class="w">    </span><span class="n">m_transpose_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_stride_in0</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">l_stride_out</span><span class="p">;</span>
<span class="linenos">221</span><span class="p">}</span>
<span class="linenos">222</span><span class="k">else</span>
<span class="linenos">223</span><span class="p">{</span>
<span class="linenos">224</span><span class="w">    </span><span class="c1">// idk if we can check for transposition without M</span>
<span class="linenos">225</span><span class="w">    </span><span class="n">m_transpose_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">226</span><span class="p">}</span>
<span class="linenos">227</span>
<span class="linenos">228</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">229</span><span class="c1">// Adjust strides based on primitive type and transposition</span>
<span class="linenos">230</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">231</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">identity</span><span class="p">)</span>
<span class="linenos">232</span><span class="p">{</span>
<span class="linenos">233</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m_transpose_output</span><span class="p">)</span>
<span class="linenos">234</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">235</span><span class="w">        </span><span class="n">m_adjusted_stride_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in0</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">];</span>
<span class="linenos">236</span><span class="w">        </span><span class="n">m_adjusted_stride_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">237</span><span class="w">        </span><span class="n">m_adjusted_stride_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_out</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">];</span>
<span class="linenos">238</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="recursive-loops-over-primitives">
<h2>5.2 Recursive Loops over Primitives<a class="headerlink" href="#recursive-loops-over-primitives" title="Link to this heading"></a></h2>
<p>After constructing our kernels, we still needed to build together an <code class="docutils literal notranslate"><span class="pre">execution</span></code> function,
in order to combine our main primitive with our first and last touches.</p>
<p>Our starting point is an <code class="docutils literal notranslate"><span class="pre">execute</span></code> function that takes the pointers to our matrices and passes
them to our <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code> function.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">starting point: <code class="docutils literal notranslate"><span class="pre">execute</span></code> function</span><a class="headerlink" href="#id9" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">247</span><span class="p">{</span>
<span class="linenos">248</span><span class="w">    </span><span class="c1">// GEMM &amp; BRGEMM</span>
<span class="linenos">249</span><span class="w">    </span><span class="n">m_adjusted_stride_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in0</span><span class="p">[</span><span class="n">m_dim_id_prim_K</span><span class="p">];</span>
<span class="linenos">250</span><span class="w">    </span><span class="n">m_adjusted_stride_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in1</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">];</span>
<span class="linenos">251</span><span class="w">    </span><span class="n">m_adjusted_stride_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_out</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">];</span>
<span class="linenos">252</span><span class="p">}</span>
<span class="linenos">253</span>
<span class="linenos">254</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">255</span><span class="c1">// Generate kernels</span>
<span class="linenos">256</span><span class="c1">/////////////////////////////////////////////////////////////////////</span>
<span class="linenos">257</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_first_touch</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">none</span><span class="p">)</span>
<span class="linenos">258</span><span class="p">{</span>
<span class="linenos">259</span><span class="w">    </span><span class="c1">// no transposition</span>
<span class="linenos">260</span><span class="w">    </span><span class="n">m_unary_first_touch</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">],</span>
<span class="linenos">261</span><span class="w">                                 </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">],</span>
<span class="linenos">262</span><span class="w">                                 </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">263</span><span class="w">                                 </span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">264</span><span class="w">                                 </span><span class="n">prim_first_touch</span><span class="p">);</span>
<span class="linenos">265</span><span class="w">    </span><span class="n">m_kernel_first_touch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_unary_first_touch</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">();</span>
<span class="linenos">266</span><span class="p">}</span>
<span class="linenos">267</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">gemm</span><span class="p">)</span>
<span class="linenos">268</span><span class="p">{</span>
<span class="linenos">269</span><span class="w">    </span><span class="c1">// no transposition</span>
<span class="linenos">270</span><span class="w">    </span><span class="n">m_brgemm_main</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">],</span>
<span class="linenos">271</span><span class="w">                           </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">],</span>
<span class="linenos">272</span><span class="w">                           </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_K</span><span class="p">],</span>
<span class="linenos">273</span><span class="w">                           </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">274</span><span class="w">                           </span><span class="mi">0</span><span class="p">,</span>
</pre></div>
</div>
</div>
<p>The ‘real’ execution happens in the <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code> function. We first check if the current iteration is the first or last access to a block in our output matrix.
Next, we update the pointers to the matrices accordingly.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">calculate if it is the first or last access in our output matrix and update pointers</span><a class="headerlink" href="#id10" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">291</span><span class="w">    </span><span class="n">m_kernel_gemm_main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_brgemm_main</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">();</span>
<span class="linenos">292</span><span class="p">}</span>
<span class="linenos">293</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_main</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ptype_t</span><span class="o">::</span><span class="n">identity</span><span class="p">)</span>
<span class="linenos">294</span><span class="p">{</span>
<span class="linenos">295</span><span class="w">    </span><span class="n">m_unary_main</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">],</span>
<span class="linenos">296</span><span class="w">                          </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">],</span>
<span class="linenos">297</span><span class="w">                          </span><span class="n">m_transpose_output</span><span class="p">,</span>
<span class="linenos">298</span><span class="w">                          </span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">299</span><span class="w">                          </span><span class="n">prim_main</span><span class="p">);</span>
<span class="linenos">300</span><span class="w">    </span><span class="n">m_kernel_unary_main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_unary_main</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">();</span>
<span class="linenos">301</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In the following step, we use our <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code> function to recursively call the <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code> function based on how many <code class="docutils literal notranslate"><span class="pre">seq</span></code> dimensions exist in our <code class="docutils literal notranslate"><span class="pre">exec_types</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">recursive call to <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code></span><a class="headerlink" href="#id11" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">303</span><span class="p">{</span>
<span class="linenos">304</span><span class="w">    </span><span class="c1">// no transposition</span>
<span class="linenos">305</span><span class="w">    </span><span class="n">m_unary_last_touch</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_M</span><span class="p">],</span>
<span class="linenos">306</span><span class="w">                                </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">m_dim_id_prim_N</span><span class="p">],</span>
<span class="linenos">307</span><span class="w">                                </span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">308</span><span class="w">                                </span><span class="n">dtype</span><span class="p">,</span>
<span class="linenos">309</span><span class="w">                                </span><span class="n">prim_last_touch</span><span class="p">);</span>
<span class="linenos">310</span><span class="w">    </span><span class="n">m_kernel_last_touch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_unary_last_touch</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">();</span>
<span class="linenos">311</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>If we have no further recursive call, we can execute the kernels.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">execute the kernels</span><a class="headerlink" href="#id12" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">313</span><span class="w">    </span><span class="n">m_kernel_first_touch_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prim_first_touch</span><span class="p">;</span>
<span class="linenos">314</span><span class="w">    </span><span class="n">m_kernel_main_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prim_main</span><span class="p">;</span>
<span class="linenos">315</span><span class="w">    </span><span class="n">m_kernel_last_touch_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prim_last_touch</span><span class="p">;</span>
<span class="linenos">316</span>
<span class="linenos">317</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">error_t</span><span class="o">::</span><span class="n">success</span><span class="p">;</span>
<span class="linenos">318</span><span class="p">}</span>
<span class="linenos">319</span>
<span class="linenos">320</span><span class="kt">void</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">TensorOperation</span><span class="o">::</span><span class="n">execute</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tensor_in0</span><span class="p">,</span>
<span class="linenos">321</span><span class="w">                                        </span><span class="kt">void</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">tensor_in1</span><span class="p">,</span>
<span class="linenos">322</span><span class="w">                                        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">tensor_out</span><span class="p">)</span>
<span class="linenos">323</span><span class="p">{</span>
<span class="linenos">324</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ptr_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tensor_in0</span><span class="p">);</span>
<span class="linenos">325</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ptr_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tensor_in1</span><span class="p">);</span>
<span class="linenos">326</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">ptr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">tensor_out</span><span class="p">);</span>
<span class="linenos">327</span>
<span class="linenos">328</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_num_parallel_loops</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">329</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">330</span><span class="w">        </span><span class="c1">// No shared loops, execute sequentially</span>
<span class="linenos">331</span><span class="w">        </span><span class="n">execute_iter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
<span class="linenos">332</span><span class="w">                     </span><span class="n">ptr_in0</span><span class="p">,</span>
<span class="linenos">333</span><span class="w">                     </span><span class="n">ptr_in1</span><span class="p">,</span>
<span class="linenos">334</span><span class="w">                     </span><span class="n">ptr_out</span><span class="p">,</span>
<span class="linenos">335</span><span class="w">                     </span><span class="nb">true</span><span class="p">,</span>
</pre></div>
</div>
</div>
</section>
<section id="performance-benchmarking">
<span id="sequential-benchmarking"></span><h2>5.3 Performance Benchmarking<a class="headerlink" href="#performance-benchmarking" title="Link to this heading"></a></h2>
<p>To test the performance of our at runtime constructed kernels and to see if everything works seamlessly together,
we were performing some reference benchmarks.</p>
<p>We were given a number of configuration parameters, that we should check:</p>
<table class="docutils align-default" id="id13">
<caption><span class="caption-text">Benchmark Configuration</span><a class="headerlink" href="#id13" title="Link to this table"></a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>1st Value</p></th>
<th class="head"><p>2nd Value</p></th>
<th class="head"><p>3rd Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>dtype</strong></p></td>
<td><p>FP32</p></td>
<td><p>FP32</p></td>
<td><p>FP32</p></td>
</tr>
<tr class="row-odd"><td><p><strong>prim_first_touch</strong></p></td>
<td><p>None</p></td>
<td><p>None</p></td>
<td><p>Zero</p></td>
</tr>
<tr class="row-even"><td><p><strong>prim_main</strong></p></td>
<td><p>GEMM</p></td>
<td><p>BRGEMM</p></td>
<td><p>BRGEMM</p></td>
</tr>
<tr class="row-odd"><td><p><strong>prim_last_touch</strong></p></td>
<td><p>None</p></td>
<td><p>None</p></td>
<td><p>ReLU</p></td>
</tr>
<tr class="row-even"><td><p><strong>dim_types</strong></p></td>
<td><p>(M, N, K, M, N, K)</p></td>
<td><p>(M, N, K, M, N, K)</p></td>
<td><p>(M, N, K, M, N, K)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>exec_types</strong></p></td>
<td><p>(Seq, Seq, Seq, Prim, Prim, Prim)</p></td>
<td><p>(Seq, Seq, Prim, Prim, Prim, Prim)</p></td>
<td><p>(Seq, Seq, Prim, Prim, Prim, Prim)</p></td>
</tr>
<tr class="row-even"><td><p><strong>dim_sizes</strong></p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>strides_in0</strong></p></td>
<td><p>(8192, 0, 1024, 1, 0, 32)</p></td>
<td><p>(8192, 0, 1024, 1, 0, 32)</p></td>
<td><p>(8192, 0, 1024, 1, 0, 32)</p></td>
</tr>
<tr class="row-even"><td><p><strong>strides_in1</strong></p></td>
<td><p>(0, 8192, 1024, 0, 32, 1)</p></td>
<td><p>(0, 8192, 1024, 0, 32, 1)</p></td>
<td><p>(0, 8192, 1024, 0, 32, 1)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>strides_out</strong></p></td>
<td><p>(32768, 1024, 0, 1, 32, 0)</p></td>
<td><p>(32768, 1024, 0, 1, 32, 0)</p></td>
<td><p>(32768, 1024, 0, 1, 32, 0)</p></td>
</tr>
</tbody>
</table>
<p>However, when benchmarking our implementation with these strides, we were running into memory leaks.
For that reason, we decided to adjust the strides of the benchmarks slightly.</p>
<table class="docutils align-default" id="id14">
<caption><span class="caption-text">Our Benchmark Configuration (bold are changes)</span><a class="headerlink" href="#id14" title="Link to this table"></a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>1st Value</p></th>
<th class="head"><p>2nd Value</p></th>
<th class="head"><p>3rd Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>dim_sizes</strong></p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
<td><p>(32, 32, 8, 32, 32, 32)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>strides_in0</strong></p></td>
<td><p>(<strong>1024</strong>, 0, <strong>32768</strong>, 1, 0, 32)</p></td>
<td><p>(<strong>1024</strong>, 0, <strong>32768</strong>, 1, 0, 32)</p></td>
<td><p>(<strong>1024</strong>, 0, <strong>32768</strong>, 1, 0, 32)</p></td>
</tr>
<tr class="row-even"><td><p><strong>strides_in1</strong></p></td>
<td><p>(0, 8192, <strong>32</strong>, 0, <strong>1024</strong>, 1)</p></td>
<td><p>(0, 8192, <strong>32</strong>, 0, <strong>1024</strong>, 1)</p></td>
<td><p>(0, 8192, <strong>32</strong>, 0, <strong>1024</strong>, 1)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>strides_out</strong></p></td>
<td><p>(<strong>32</strong>, <strong>32768</strong>, 0, 1, <strong>1024</strong>, 0)</p></td>
<td><p>(<strong>32</strong>, <strong>32768</strong>, 0, 1, <strong>1024</strong>, 0)</p></td>
<td><p>(<strong>32</strong>, <strong>32768</strong>, 0, 1, <strong>1024</strong>, 0)</p></td>
</tr>
</tbody>
</table>
<p>When benchmarking our configurations we achieved the following <code class="docutils literal notranslate"><span class="pre">GFLOP</span></code> performance:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOP</span></code> performance of our benchmark configuration</span><a class="headerlink" href="#id15" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Running TensorOperationBench benchmark #1
<span class="linenos"> 2</span>Total time (s):                  3.0052
<span class="linenos"> 3</span>Total reps:                      398
<span class="linenos"> 4</span>Total floating point operations: 213674622976
<span class="linenos"> 5</span>Estimated GFLOPS/sec:            71.1017
<span class="linenos"> 6</span>--------------------------------------------------
<span class="linenos"> 7</span>Running TensorOperationBench benchmark #2
<span class="linenos"> 8</span>Total time (s):                  3.0062
<span class="linenos"> 9</span>Total reps:                      413
<span class="linenos">10</span>Total floating point operations: 221727686656
<span class="linenos">11</span>Estimated GFLOPS/sec:            73.7568
<span class="linenos">12</span>--------------------------------------------------
<span class="linenos">13</span>Running TensorOperationBench benchmark #3
<span class="linenos">14</span>Total time (s):                  3.00738
<span class="linenos">15</span>Total reps:                      400
<span class="linenos">16</span>Total floating point operations: 214748364800
<span class="linenos">17</span>Estimated GFLOPS/sec:            71.4071
<span class="linenos">18</span>--------------------------------------------------
</pre></div>
</div>
</div>
<p>The results show that we achieve between <code class="docutils literal notranslate"><span class="pre">71-73</span> <span class="pre">GFLOPs</span></code> for all our executions.
These results are somewhat consistent with calling the kernels themselves independently.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the submission we made some minor changes to our implementation.
First, we fixed some errors and were then able to use the strides that we were provided with.
Secondly, we decided to enhance our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> implementation.
Afterwards we able to calculate kernels of size <code class="docutils literal notranslate"><span class="pre">16x4</span></code> instead of <code class="docutils literal notranslate"><span class="pre">8x4</span></code>.
This helped us increase the results from <code class="docutils literal notranslate"><span class="pre">71-73</span> <span class="pre">GFLOPs</span></code> to around <code class="docutils literal notranslate"><span class="pre">90-91</span> <span class="pre">GFLOPs</span></code>.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOP</span></code> performance initial benchmark configuration with enhanced <code class="docutils literal notranslate"><span class="pre">matmul</span></code> kernel</span><a class="headerlink" href="#id16" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Running TensorOperationBench benchmark #1
<span class="linenos"> 2</span>Total time (s):                  3.00343
<span class="linenos"> 3</span>Total reps:                      510
<span class="linenos"> 4</span>Total floating point operations: 273804165120
<span class="linenos"> 5</span>Estimated GFLOPS/sec:            91.1637
<span class="linenos"> 6</span>--------------------------------------------------
<span class="linenos"> 7</span>Running TensorOperationBench benchmark #2
<span class="linenos"> 8</span>Total time (s):                  3.00537
<span class="linenos"> 9</span>Total reps:                      514
<span class="linenos">10</span>Total floating point operations: 275951648768
<span class="linenos">11</span>Estimated GFLOPS/sec:            91.8195
<span class="linenos">12</span>--------------------------------------------------
<span class="linenos">13</span>Running TensorOperationBench benchmark #3
<span class="linenos">14</span>Total time (s):                  3.00405
<span class="linenos">15</span>Total reps:                      505
<span class="linenos">16</span>Total floating point operations: 271119810560
<span class="linenos">17</span>Estimated GFLOPS/sec:            90.2515
<span class="linenos">18</span>--------------------------------------------------
</pre></div>
</div>
</div>
</section>
<section id="shared-memory-parallelization">
<h2>5.4 Shared Memory Parallelization<a class="headerlink" href="#shared-memory-parallelization" title="Link to this heading"></a></h2>
<p>To enable the execution of shared loops, we needed to make a few adjustments to our <code class="docutils literal notranslate"><span class="pre">setup</span></code> code:</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">gather shared loop id’s and dimension sizes</span><a class="headerlink" href="#id17" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">137</span><span class="p">{</span>
<span class="linenos">138</span><span class="w">    </span><span class="n">m_dim_id_prim_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">139</span><span class="p">}</span>
<span class="linenos">140</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_id_prim_N</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">141</span><span class="p">{</span>
<span class="linenos">142</span><span class="w">    </span><span class="n">m_dim_id_prim_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">143</span><span class="p">}</span>
<span class="linenos">144</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_id_prim_K</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">k</span><span class="p">)</span>
<span class="linenos">145</span><span class="p">{</span>
<span class="linenos">146</span><span class="w">    </span><span class="n">m_dim_id_prim_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">147</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">assign the size of the <code class="docutils literal notranslate"><span class="pre">shared</span></code> dimensions according to the order in <code class="docutils literal notranslate"><span class="pre">dim_types</span></code></span><a class="headerlink" href="#id18" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">169</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">170</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">k</span><span class="p">)</span>
<span class="linenos">171</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">172</span><span class="w">        </span><span class="n">m_dim_id_seq_K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">173</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">174</span><span class="p">}</span>
<span class="linenos">175</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_exec_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">shared</span><span class="p">)</span>
<span class="linenos">176</span><span class="p">{</span>
<span class="linenos">177</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">m</span><span class="p">)</span>
<span class="linenos">178</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">179</span><span class="w">        </span><span class="n">m_dim_id_sha_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">180</span><span class="w">        </span><span class="n">m_num_parallel_loops</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">181</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In our execute function we would just needed to check if our <code class="docutils literal notranslate"><span class="pre">m_num_parallel_loops</span></code> variable would be greater
than zero. If this was the case we would execute our <code class="docutils literal notranslate"><span class="pre">execute_iter_parallel</span></code> function:</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">multiply <code class="docutils literal notranslate"><span class="pre">shared</span></code> loop sizes to get total number of iterations</span><a class="headerlink" href="#id19" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">345</span><span class="w">                              </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">346</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">347</span><span class="p">}</span>
<span class="linenos">348</span>
<span class="linenos">349</span><span class="kt">void</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">TensorOperation</span><span class="o">::</span><span class="n">execute_iter</span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">id_loop</span><span class="p">,</span>
<span class="linenos">350</span><span class="w">                                             </span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_in0</span><span class="p">,</span>
</pre></div>
</div>
</div>
<p>The idea is to get a flat iteration space that can be used to parallelize over.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">multiply <code class="docutils literal notranslate"><span class="pre">shared</span></code> loop sizes to get total number of iterations</span><a class="headerlink" href="#id20" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">352</span><span class="w">                                             </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_out</span><span class="p">,</span>
<span class="linenos">353</span><span class="w">                                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">first_access</span><span class="p">,</span>
<span class="linenos">354</span><span class="w">                                             </span><span class="kt">bool</span><span class="w"> </span><span class="n">last_access</span><span class="p">)</span>
<span class="linenos">355</span><span class="p">{</span>
<span class="linenos">356</span><span class="w">    </span><span class="c1">// there is only one iteration if the dimension is the first primitive</span>
<span class="linenos">357</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id_loop</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">m_id_first_primitive_loop</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">358</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">dtype_sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtype_size</span><span class="p">();</span>
<span class="linenos">359</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_stride_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in0</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dtype_sz</span><span class="p">;</span>
<span class="linenos">360</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_stride_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_in1</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dtype_sz</span><span class="p">;</span>
<span class="linenos">361</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_stride_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_strides_out</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dtype_sz</span><span class="p">;</span>
<span class="linenos">362</span>
<span class="linenos">363</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">l_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_iter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_size</span><span class="p">;</span><span class="w"> </span><span class="n">l_iter</span><span class="o">++</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We ‘unflatten’ the OpenMP iteration index <code class="docutils literal notranslate"><span class="pre">l_it_all</span></code> into a set of loop indices, one for each shared loop dimension.
These indices are then used to compute the offsets for the <code class="docutils literal notranslate"><span class="pre">in0</span></code>, <code class="docutils literal notranslate"><span class="pre">in1</span></code>, and <code class="docutils literal notranslate"><span class="pre">out</span></code> tensors:</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">calculate the tensor <code class="docutils literal notranslate"><span class="pre">offsets</span></code></span><a class="headerlink" href="#id21" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">365</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_access</span><span class="p">;</span>
<span class="linenos">366</span><span class="kt">bool</span><span class="w"> </span><span class="n">is_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last_access</span><span class="p">;</span>
<span class="linenos">367</span><span class="c1">// if the size is 1, it is always the first and last access</span>
<span class="linenos">368</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m_dim_types</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">k</span><span class="p">)</span>
<span class="linenos">369</span><span class="p">{</span>
<span class="linenos">370</span><span class="w">    </span><span class="n">is_first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_access</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">l_iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">371</span><span class="w">    </span><span class="n">is_last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last_access</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">l_iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">m_dim_sizes</span><span class="p">[</span><span class="n">id_loop</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">372</span><span class="p">}</span>
<span class="linenos">373</span>
<span class="linenos">374</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">sub_ptr_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr_in0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_iter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_stride_in0</span><span class="p">;</span>
<span class="linenos">375</span><span class="kt">char</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">sub_ptr_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr_in1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_iter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_stride_in1</span><span class="p">;</span>
<span class="linenos">376</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">sub_ptr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr_out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_iter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_stride_out</span><span class="p">;</span>
<span class="linenos">377</span>
<span class="linenos">378</span><span class="c1">// Recursive Call</span>
<span class="linenos">379</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id_loop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_id_first_primitive_loop</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Here we are calculating the offset for the current thread.
Every shared loop contributes to the calculation with its corresponding stride.</p>
<p>Lastly, we call our <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code> function.
Depending on whether we have a <code class="docutils literal notranslate"><span class="pre">seq</span></code> dimension, we need to be careful, which id we pass to the function:</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">call remaining loops with <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code></span><a class="headerlink" href="#id22" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">381</span><span class="w">    </span><span class="n">execute_iter</span><span class="p">(</span><span class="n">id_loop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">382</span><span class="w">                 </span><span class="n">sub_ptr_in0</span><span class="p">,</span>
<span class="linenos">383</span><span class="w">                 </span><span class="n">sub_ptr_in1</span><span class="p">,</span>
<span class="linenos">384</span><span class="w">                 </span><span class="n">sub_ptr_out</span><span class="p">,</span>
<span class="linenos">385</span><span class="w">                 </span><span class="n">is_first</span><span class="p">,</span>
<span class="linenos">386</span><span class="w">                 </span><span class="n">is_last</span><span class="p">);</span>
<span class="linenos">387</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>We were also executing the benchmark configurations from the <a class="reference internal" href="#sequential-benchmarking"><span class="std std-ref">sequential execution</span></a> task.
We were executing our benchmarks using <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=4</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOP</span></code> performance for <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">shared</span></code> loop execution</span><a class="headerlink" href="#id23" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Running SharedTensorOperationBench benchmark #1
<span class="linenos"> 2</span>Total time (s):                  3.00107
<span class="linenos"> 3</span>Total reps:                      1993
<span class="linenos"> 4</span>Total floating point operations: 1069983727616
<span class="linenos"> 5</span>Estimated GFLOPS/sec:            356.534
<span class="linenos"> 6</span>--------------------------------------------------
<span class="linenos"> 7</span>Running SharedTensorOperationBench benchmark #2
<span class="linenos"> 8</span>Total time (s):                  3.00002
<span class="linenos"> 9</span>Total reps:                      2168
<span class="linenos">10</span>Total floating point operations: 1163936137216
<span class="linenos">11</span>Estimated GFLOPS/sec:            387.976
<span class="linenos">12</span>--------------------------------------------------
<span class="linenos">13</span>Running SharedTensorOperationBench benchmark #3
<span class="linenos">14</span>Total time (s):                  3.00093
<span class="linenos">15</span>Total reps:                      2126
<span class="linenos">16</span>Total floating point operations: 1141387558912
<span class="linenos">17</span>Estimated GFLOPS/sec:            380.345
<span class="linenos">18</span>--------------------------------------------------
</pre></div>
</div>
</div>
<p>With the parallelization we achieve about <code class="docutils literal notranslate"><span class="pre">360</span> <span class="pre">-</span> <span class="pre">390</span> <span class="pre">GFLOPs</span></code>.</p>
</section>
<section id="optimization-passes">
<h2>5.5 Optimization Passes<a class="headerlink" href="#optimization-passes" title="Link to this heading"></a></h2>
<p>Our approach to enhancing the performance of the tensor operations was to use a vector of <code class="docutils literal notranslate"><span class="pre">struct</span></code>’s for each dimension that we have got:</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">call remaining loops with <code class="docutils literal notranslate"><span class="pre">execute_iter</span></code></span><a class="headerlink" href="#id24" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">17</span><span class="k">struct</span><span class="w"> </span><span class="nc">Dimension</span>
<span class="linenos">18</span><span class="p">{</span>
<span class="linenos">19</span><span class="w">    </span><span class="c1">//! Type of the dimension (M, N, K)</span>
<span class="linenos">20</span><span class="w">    </span><span class="n">dim_t</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">undefined</span><span class="p">;</span>
<span class="linenos">21</span><span class="w">    </span><span class="c1">//! Execution type (Prim, Seq, Shared, ...)</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">exec_t</span><span class="w"> </span><span class="n">exec_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">undefined</span><span class="p">;</span>
<span class="linenos">23</span><span class="w">    </span><span class="c1">//! Dimension size</span>
<span class="linenos">24</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">25</span><span class="w">    </span><span class="c1">//! Stride in the first input tensor</span>
<span class="linenos">26</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_in0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">27</span><span class="w">    </span><span class="c1">//! Stride in the second input tensor</span>
<span class="linenos">28</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">    </span><span class="c1">//! Stride in the output tensor</span>
<span class="linenos">30</span><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="w">    </span><span class="cm">/**</span>
<span class="linenos">33</span><span class="cm">     * @brief Construct a new Dimension object.</span>
<span class="linenos">34</span><span class="cm">     *</span>
<span class="linenos">35</span><span class="cm">     * @param type Type of the dimension (M, N, K).</span>
<span class="linenos">36</span><span class="cm">     * @param exec_type Execution type (Prim, Seq, Shared, ...).</span>
<span class="linenos">37</span><span class="cm">     * @param size Size of the dimension.</span>
<span class="linenos">38</span><span class="cm">     * @param stride_in0 Stride in the first input tensor.</span>
<span class="linenos">39</span><span class="cm">     * @param stride_in1 Stride in the second input tensor.</span>
<span class="linenos">40</span><span class="cm">     * @param stride_out Stride in the output tensor.</span>
<span class="linenos">41</span><span class="cm">     */</span>
<span class="linenos">42</span><span class="w">    </span><span class="n">Dimension</span><span class="p">(</span><span class="n">dim_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span>
<span class="linenos">43</span><span class="w">              </span><span class="n">exec_t</span><span class="w"> </span><span class="n">exec_type</span><span class="p">,</span>
<span class="linenos">44</span><span class="w">              </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">              </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_in0</span><span class="p">,</span>
<span class="linenos">46</span><span class="w">              </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_in1</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">              </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">stride_out</span><span class="p">)</span>
<span class="linenos">48</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span>
<span class="linenos">49</span><span class="w">          </span><span class="n">exec_type</span><span class="p">(</span><span class="n">exec_type</span><span class="p">),</span>
<span class="linenos">50</span><span class="w">          </span><span class="n">size</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
<span class="linenos">51</span><span class="w">          </span><span class="n">stride_in0</span><span class="p">(</span><span class="n">stride_in0</span><span class="p">),</span>
<span class="linenos">52</span><span class="w">          </span><span class="n">stride_in1</span><span class="p">(</span><span class="n">stride_in1</span><span class="p">),</span>
<span class="linenos">53</span><span class="w">          </span><span class="n">stride_out</span><span class="p">(</span><span class="n">stride_out</span><span class="p">)</span>
<span class="linenos">54</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">55</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">56</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">57</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span><span class="s">&quot;Dimension size needs to be greater than 0&quot;</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">60</span><span class="p">};</span>
</pre></div>
</div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">struct</span></code> is used to store all information about a dimension.</p>
<p>After setting this up, we could create our optimization passes.</p>
<section id="primitive-identification">
<h3>5.5.1 Primitive Identification<a class="headerlink" href="#primitive-identification" title="Link to this heading"></a></h3>
<p>The first optimization that we performed was to find primitive dimensions.
This optimization would be useful, for cases, where we were given only sequential loops.
Our approach to this optimization was the following:</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">finding the <code class="docutils literal notranslate"><span class="pre">K2</span> <span class="pre">prim</span></code> dimension for the <code class="docutils literal notranslate"><span class="pre">BRGEMM</span></code> case</span><a class="headerlink" href="#id25" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">33</span><span class="kt">void</span><span class="w"> </span><span class="nf">mini_jit::ir::Optimizer::optimize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">dim_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim_types</span><span class="p">,</span>
<span class="linenos">34</span><span class="w">                                       </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">exec_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">exec_types</span><span class="p">,</span>
<span class="linenos">35</span><span class="w">                                       </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim_sizes</span><span class="p">,</span>
<span class="linenos">36</span><span class="w">                                       </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strides_in0</span><span class="p">,</span>
<span class="linenos">37</span><span class="w">                                       </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strides_in1</span><span class="p">,</span>
<span class="linenos">38</span><span class="w">                                       </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">strides_out</span><span class="p">,</span>
<span class="linenos">39</span><span class="w">                                       </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">thread_target</span><span class="p">,</span>
<span class="linenos">40</span><span class="w">                                       </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">max_kernel_size</span><span class="p">)</span>
<span class="linenos">41</span><span class="p">{</span>
<span class="linenos">42</span><span class="w">    </span><span class="c1">// Convert input vectors to a vector of Dimensions</span>
<span class="linenos">43</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">mini_jit</span><span class="o">::</span><span class="n">ir</span><span class="o">::</span><span class="n">Dimension</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dimensions</span><span class="p">;</span>
<span class="linenos">44</span><span class="w">    </span><span class="n">IRConverter</span><span class="o">::</span><span class="n">convertConfigToDimensions</span><span class="p">(</span><span class="n">dim_types</span><span class="p">,</span>
<span class="linenos">45</span><span class="w">                                           </span><span class="n">exec_types</span><span class="p">,</span>
<span class="linenos">46</span><span class="w">                                           </span><span class="n">dim_sizes</span><span class="p">,</span>
<span class="linenos">47</span><span class="w">                                           </span><span class="n">strides_in0</span><span class="p">,</span>
<span class="linenos">48</span><span class="w">                                           </span><span class="n">strides_in1</span><span class="p">,</span>
<span class="linenos">49</span><span class="w">                                           </span><span class="n">strides_out</span><span class="p">,</span>
<span class="linenos">50</span><span class="w">                                           </span><span class="n">dimensions</span><span class="p">);</span>
<span class="linenos">51</span><span class="w">    </span><span class="c1">// Optimize the dimensions</span>
<span class="linenos">52</span><span class="w">    </span><span class="n">optimize</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span><span class="w"> </span><span class="n">thread_target</span><span class="p">,</span><span class="w"> </span><span class="n">max_kernel_size</span><span class="p">);</span>
<span class="linenos">53</span><span class="w">    </span><span class="c1">// Convert the optimized dimensions back to the original format</span>
<span class="linenos">54</span><span class="w">    </span><span class="n">IRConverter</span><span class="o">::</span><span class="n">convertDimensionsToConfig</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span>
<span class="linenos">55</span><span class="w">                                           </span><span class="n">dim_types</span><span class="p">,</span>
</pre></div>
</div>
</div>
<p>We were trying to identify the respective dimensions by looking at the strides of the <code class="docutils literal notranslate"><span class="pre">in1</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code> tensors.
As a starting point we use that for column-major <code class="docutils literal notranslate"><span class="pre">BRGEMM</span></code>’s we have to have a certain mask for our tensors <code class="docutils literal notranslate"><span class="pre">...M,</span> <span class="pre">...K1</span> <span class="pre">-&gt;</span> <span class="pre">...M</span></code>, which we were trying to follow.
This means that the <code class="docutils literal notranslate"><span class="pre">K2</span></code> that we would need for our <code class="docutils literal notranslate"><span class="pre">BRGEMM</span></code> should not have any unit-stride in the first input tensor.</p>
<p>Similarly, we did the same for:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">M</span></code> dimension</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N</span></code> dimension</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">K1</span></code> dimension</p></li>
</ul>
<p>For the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension, where we did not have any indication about which matrix to choose, we simply choose the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension, with the smallest stride:</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">finding the <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">prim</span></code> dimension with smallest stride</span><a class="headerlink" href="#id26" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 85</span><span class="w">                                 </span><span class="p">{</span>
<span class="linenos"> 86</span><span class="w">                                     </span><span class="k">return</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">c</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">exec_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="w">                                 </span><span class="p">});</span>
<span class="linenos"> 88</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_c_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 89</span><span class="p">{</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// primary dimensions already set</span>
<span class="linenos"> 91</span><span class="p">}</span>
<span class="linenos"> 92</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prim_c_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 93</span><span class="p">{</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span><span class="s">&quot;Optimizer: Expected 0 or 2 primary dimensions of type &#39;c&#39;, found &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">prim_c_count</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;. Try setting all dimensions to seq or undefined.&quot;</span><span class="p">);</span>
<span class="linenos"> 95</span><span class="p">}</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos"> 98</span><span class="c1">// FIND UNARY PRIM M</span>
<span class="linenos"> 99</span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">100</span><span class="c1">// req: unit stride in in0. Out might not be 1 if operation transposes.</span>
<span class="linenos">101</span><span class="k">auto</span><span class="w"> </span><span class="n">l_dim_m_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="linenos">102</span><span class="w">                               </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">ir</span><span class="o">::</span><span class="n">Dimension</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">)</span>
<span class="linenos">103</span><span class="w">                               </span><span class="p">{</span>
<span class="linenos">104</span><span class="w">                                   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">105</span><span class="w">                                          </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_in0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">106</span><span class="w">                                          </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_in1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">                               </span><span class="p">});</span>
</pre></div>
</div>
</div>
<p>We did the ‘identification’ process in the order <code class="docutils literal notranslate"><span class="pre">K2,</span> <span class="pre">M,</span> <span class="pre">N,</span> <span class="pre">K1</span></code>.
The reason for this order was that after the identification, we would rotate the respective dimension to the end of the order.
This would then ultimately lead to the structure: <code class="docutils literal notranslate"><span class="pre">...,</span> <span class="pre">K2,</span> <span class="pre">M,</span> <span class="pre">N,</span> <span class="pre">K1</span></code> for our ‘identified’ primitive dimensions.</p>
</section>
<section id="splitting-dimensions">
<h3>5.5.2 Splitting Dimensions<a class="headerlink" href="#splitting-dimensions" title="Link to this heading"></a></h3>
<p>For our second optimization pass we decided to look at the dimension sizes of our loops.
That means for the case that a <code class="docutils literal notranslate"><span class="pre">prim</span></code> dimension would be larger than <code class="docutils literal notranslate"><span class="pre">1024</span></code> we would decide to split it in two dimensions:</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">split large <code class="docutils literal notranslate"><span class="pre">prim</span></code> dimensions</span><a class="headerlink" href="#id27" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">150</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">151</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">152</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">153</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span><span class="s">&quot;Optimizer: No suitable primary dimension N found.&quot;</span><span class="p">);</span>
<span class="linenos">154</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">155</span><span class="p">}</span>
<span class="linenos">156</span><span class="k">else</span>
<span class="linenos">157</span><span class="p">{</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">// TODO: check if this is ok</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// FIND UNARY PRIM N</span>
<span class="linenos">162</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">163</span><span class="w">    </span><span class="c1">// req: choose the one with the smallest stride in in0</span>
<span class="linenos">164</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l_n_dim_stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INT_MAX</span><span class="p">;</span>
<span class="linenos">165</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l_n_dim_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">166</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">167</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">168</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">169</span><span class="w">            </span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stride_in1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">170</span><span class="w">            </span><span class="p">(</span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">exec_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">undefined</span><span class="w"> </span><span class="o">||</span>
<span class="linenos">171</span><span class="w">             </span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">exec_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">seq</span><span class="p">))</span>
<span class="linenos">172</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">173</span><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">l_current_stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stride_in0</span><span class="p">;</span>
<span class="linenos">174</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_current_stride</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_n_dim_stride</span><span class="p">)</span>
<span class="linenos">175</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">176</span><span class="w">                </span><span class="n">l_n_dim_stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_current_stride</span><span class="p">;</span>
<span class="linenos">177</span><span class="w">                </span><span class="n">l_n_dim_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">178</span><span class="w">            </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>If a <code class="docutils literal notranslate"><span class="pre">prim</span></code> dimension would be large enough, we would call our <code class="docutils literal notranslate"><span class="pre">findBestSplit</span></code> function.
Our <code class="docutils literal notranslate"><span class="pre">findBestSplit</span></code> function is designed after the dimensions in our <code class="docutils literal notranslate"><span class="pre">matmul_m_n_k</span></code> kernel.
Depending on the dimension we want to split we are here selecting the ideal sizes.</p>
<p>That means we start with the <code class="docutils literal notranslate"><span class="pre">M</span></code> dimension to find an appropriate match:</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">M</span></code> dimension split</span><a class="headerlink" href="#id28" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">230</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">231</span><span class="p">}</span>
<span class="linenos">232</span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">233</span><span class="c1">// FIND PRIM M</span>
<span class="linenos">234</span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">235</span><span class="c1">// req: unit stride in in0 and out</span>
<span class="linenos">236</span><span class="k">auto</span><span class="w"> </span><span class="n">l_dim_m_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="linenos">237</span><span class="w">                               </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">ir</span><span class="o">::</span><span class="n">Dimension</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">)</span>
<span class="linenos">238</span><span class="w">                               </span><span class="p">{</span>
<span class="linenos">239</span><span class="w">                                   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">m</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">240</span><span class="w">                                          </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_in0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">241</span><span class="w">                                          </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_in1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">242</span><span class="w">                                          </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_out</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">243</span><span class="w">                               </span><span class="p">});</span>
<span class="linenos">244</span>
<span class="linenos">245</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_dim_m_it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">246</span><span class="p">{</span>
<span class="linenos">247</span><span class="w">    </span><span class="c1">// set dimension data</span>
<span class="linenos">248</span><span class="w">    </span><span class="n">l_dim_m_it</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">m</span><span class="p">;</span>
<span class="linenos">249</span><span class="w">    </span><span class="n">l_dim_m_it</span><span class="o">-&gt;</span><span class="n">exec_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">;</span>
<span class="linenos">250</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_dim_m_it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">251</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">252</span><span class="w">        </span><span class="c1">// move M to the back</span>
<span class="linenos">253</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">l_dim_m_it</span><span class="p">,</span><span class="w"> </span><span class="n">l_dim_m_it</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="linenos">254</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Similarly, we do the same for the <code class="docutils literal notranslate"><span class="pre">N</span></code> dimension, where we want multiples of <code class="docutils literal notranslate"><span class="pre">4</span></code> and for <code class="docutils literal notranslate"><span class="pre">K</span></code> we are flexible.</p>
</section>
<section id="id1">
<h3>5.5.3 Shared Memory Parallelization<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>Our third optimization pass was to make all loops that were not a <code class="docutils literal notranslate"><span class="pre">prim</span></code> dimension and of the dimension-type <code class="docutils literal notranslate"><span class="pre">M</span></code> or <code class="docutils literal notranslate"><span class="pre">N</span></code> a <code class="docutils literal notranslate"><span class="pre">shared</span></code> loop.
For that we initially check how many loops are already of dimension-type <code class="docutils literal notranslate"><span class="pre">shared</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">finding the <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">prim</span></code> dimension with smallest stride</span><a class="headerlink" href="#id29" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">184</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">invalid_argument</span><span class="p">(</span><span class="s">&quot;Optimizer: No suitable primary dimension N found.&quot;</span><span class="p">);</span>
<span class="linenos">185</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="w">    </span><span class="c1">// set dimension data</span>
<span class="linenos">188</span><span class="w">    </span><span class="n">dimensions</span><span class="p">[</span><span class="n">l_n_dim_id</span><span class="p">].</span><span class="n">exec_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">prim</span><span class="p">;</span>
<span class="linenos">189</span><span class="w">    </span><span class="c1">// move N to the back</span>
<span class="linenos">190</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_n_dim_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">191</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">192</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_n_dim_id</span><span class="p">,</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_n_dim_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="linenos">193</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">194</span><span class="p">}</span>
<span class="linenos">195</span>
<span class="linenos">196</span><span class="c1">// lastly, set all remaining dimensions to seq</span>
<span class="linenos">197</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dimensions</span><span class="p">)</span>
<span class="linenos">198</span><span class="p">{</span>
<span class="linenos">199</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="p">.</span><span class="n">exec_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">exec_t</span><span class="o">::</span><span class="n">undefined</span><span class="p">)</span>
<span class="linenos">200</span><span class="w">    </span><span class="p">{</span>
</pre></div>
</div>
</div>
<p>For the case that we already have a high number of <code class="docutils literal notranslate"><span class="pre">shared</span></code> loops we do not create any more and simply return.
Otherwise we check the <code class="docutils literal notranslate"><span class="pre">seq</span></code> dimensions for potential candidates:</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">select <code class="docutils literal notranslate"><span class="pre">shared</span></code> loop candidates</span><a class="headerlink" href="#id30" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">202</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">203</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">204</span>
<span class="linenos">205</span><span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"> </span><span class="c1">// all primary dimensions set</span>
<span class="linenos">206</span><span class="p">}</span>
<span class="linenos">207</span><span class="k">else</span>
<span class="linenos">208</span><span class="p">{</span>
<span class="linenos">209</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">210</span><span class="w">    </span><span class="c1">// FIND PRIM BR (second K)</span>
<span class="linenos">211</span><span class="w">    </span><span class="c1">/////////////////////////////////////////////////////////////////</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">// req: no unit stride in in1, stride_out has to be 0</span>
<span class="linenos">213</span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_dim_BR_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="linenos">214</span><span class="w">                                    </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">mini_jit</span><span class="o">::</span><span class="n">ir</span><span class="o">::</span><span class="n">Dimension</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dim</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As a last step we move all our <code class="docutils literal notranslate"><span class="pre">shared</span></code> loops to the front of the order:</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">move <code class="docutils literal notranslate"><span class="pre">shared</span></code> loops to the front</span><a class="headerlink" href="#id31" title="Link to this code"></a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">216</span><span class="w">                                    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">k</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">dim_t</span><span class="o">::</span><span class="n">undefined</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">217</span><span class="w">                                           </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_in1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="linenos">218</span><span class="w">                                           </span><span class="n">dim</span><span class="p">.</span><span class="n">stride_out</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">219</span><span class="w">                                </span><span class="p">});</span>
<span class="linenos">220</span>
<span class="linenos">221</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_dim_BR_it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
</pre></div>
</div>
</div>
</section>
<section id="performance-benchmarks">
<h3>5.5.6 Performance Benchmarks<a class="headerlink" href="#performance-benchmarks" title="Link to this heading"></a></h3>
<p>We also benchmarked the results for two given configurations:</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">GFLOP</span></code> performance for sample configurations</span><a class="headerlink" href="#id32" title="Link to this code"></a></div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>Running SharedTensorOperationBench benchmark #1
<span class="linenos"> 2</span>Total time (s):                  3.01164
<span class="linenos"> 3</span>Total reps:                      101
<span class="linenos"> 4</span>Total floating point operations: 827392000000
<span class="linenos"> 5</span>Estimated GFLOPS/sec:            274.731
<span class="linenos"> 6</span>--------------------------------------------------
<span class="linenos"> 7</span>#####################################################
<span class="linenos"> 8</span>Testing different kernel sizes
<span class="linenos"> 9</span>#####################################################
<span class="linenos">10</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 1024)
<span class="linenos">11</span>Total time (s):                  3.02859
<span class="linenos">12</span>Total reps:                      105
<span class="linenos">13</span>Total floating point operations: 860160000000
<span class="linenos">14</span>Estimated GFLOPS/sec:            284.013
<span class="linenos">15</span>--------------------------------------------------
<span class="linenos">16</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 1024)
<span class="linenos">17</span>Total time (s):                  3.02753
<span class="linenos">18</span>Total reps:                      105
<span class="linenos">19</span>Total floating point operations: 860160000000
<span class="linenos">20</span>Estimated GFLOPS/sec:            284.113
<span class="linenos">21</span>--------------------------------------------------
<span class="linenos">22</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 512)
<span class="linenos">23</span>Total time (s):                  3.0037
<span class="linenos">24</span>Total reps:                      95
<span class="linenos">25</span>Total floating point operations: 778240000000
<span class="linenos">26</span>Estimated GFLOPS/sec:            259.093
<span class="linenos">27</span>--------------------------------------------------
<span class="linenos">28</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 512)
<span class="linenos">29</span>Total time (s):                  3.00784
<span class="linenos">30</span>Total reps:                      95
<span class="linenos">31</span>Total floating point operations: 778240000000
<span class="linenos">32</span>Estimated GFLOPS/sec:            258.738
<span class="linenos">33</span>--------------------------------------------------
<span class="linenos">34</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 256)
<span class="linenos">35</span>Total time (s):                  3.01035
<span class="linenos">36</span>Total reps:                      112
<span class="linenos">37</span>Total floating point operations: 917504000000
<span class="linenos">38</span>Estimated GFLOPS/sec:            304.783
<span class="linenos">39</span>--------------------------------------------------
<span class="linenos">40</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 256)
<span class="linenos">41</span>Total time (s):                  3.00121
<span class="linenos">42</span>Total reps:                      110
<span class="linenos">43</span>Total floating point operations: 901120000000
<span class="linenos">44</span>Estimated GFLOPS/sec:            300.253
<span class="linenos">45</span>--------------------------------------------------
<span class="linenos">46</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 125)
<span class="linenos">47</span>Total time (s):                  3.00583
<span class="linenos">48</span>Total reps:                      129
<span class="linenos">49</span>Total floating point operations: 1056768000000
<span class="linenos">50</span>Estimated GFLOPS/sec:            351.573
<span class="linenos">51</span>--------------------------------------------------
<span class="linenos">52</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 125)
<span class="linenos">53</span>Total time (s):                  3.00655
<span class="linenos">54</span>Total reps:                      129
<span class="linenos">55</span>Total floating point operations: 1056768000000
<span class="linenos">56</span>Estimated GFLOPS/sec:            351.488
<span class="linenos">57</span>--------------------------------------------------
<span class="linenos">58</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 64)
<span class="linenos">59</span>Total time (s):                  3.01405
<span class="linenos">60</span>Total reps:                      119
<span class="linenos">61</span>Total floating point operations: 974848000000
<span class="linenos">62</span>Estimated GFLOPS/sec:            323.435
<span class="linenos">63</span>--------------------------------------------------
<span class="linenos">64</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 64)
<span class="linenos">65</span>Total time (s):                  3.01289
<span class="linenos">66</span>Total reps:                      119
<span class="linenos">67</span>Total floating point operations: 974848000000
<span class="linenos">68</span>Estimated GFLOPS/sec:            323.559
<span class="linenos">69</span>--------------------------------------------------
<span class="linenos">70</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 32)
<span class="linenos">71</span>Total time (s):                  3.00815
<span class="linenos">72</span>Total reps:                      125
<span class="linenos">73</span>Total floating point operations: 1024000000000
<span class="linenos">74</span>Estimated GFLOPS/sec:            340.409
<span class="linenos">75</span>--------------------------------------------------
<span class="linenos">76</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 32)
<span class="linenos">77</span>Total time (s):                  3.00952
<span class="linenos">78</span>Total reps:                      126
<span class="linenos">79</span>Total floating point operations: 1032192000000
<span class="linenos">80</span>Estimated GFLOPS/sec:            342.975
<span class="linenos">81</span>--------------------------------------------------
<span class="linenos">82</span>Running SharedTensorOperationBench benchmark (thread_target: 64, max_kernel_size: 16)
<span class="linenos">83</span>Total time (s):                  3.0137
<span class="linenos">84</span>Total reps:                      40
<span class="linenos">85</span>Total floating point operations: 327680000000
<span class="linenos">86</span>Estimated GFLOPS/sec:            108.73
<span class="linenos">87</span>--------------------------------------------------
<span class="linenos">88</span>Running SharedTensorOperationBench benchmark (thread_target: 256, max_kernel_size: 16)
<span class="linenos">89</span>Total time (s):                  3.01834
<span class="linenos">90</span>Total reps:                      119
<span class="linenos">91</span>Total floating point operations: 974848000000
<span class="linenos">92</span>Estimated GFLOPS/sec:            322.975
<span class="linenos">93</span>--------------------------------------------------
</pre></div>
</div>
</div>
<p>For the execution of these configs we receive around <code class="docutils literal notranslate"><span class="pre">250</span> <span class="pre">-</span> <span class="pre">260</span> <span class="pre">GFLOPs</span></code>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="04_code_gen.html" class="btn btn-neutral float-left" title="4. Code Generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api/namespaces/mini_jit.html" class="btn btn-neutral float-right" title="mini_jit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Lucas Obitz, Luca-Philipp Grumbach.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>